<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Moving Report Generator - v5.5 (Enhanced)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>

    <style>
      :root {
        --company-pink: #f04e98;
        --knicks-orange-accent: #f58426;
        --knicks-blue-accent: #006bb6;
        --text-light: #ffffff;
        --danger-red: #dc3545;
        --danger-red-light: #f8d7da;

        /* Light Theme (Default) */
        --primary-bg: #f4f6f8;
        --secondary-bg: #ffffff;
        --text-primary: #1f2937;
        --text-secondary: #4b5563;
        --border-color: #d1d5db;
        --input-bg: #ffffff;
        --input-text: #1f2937;
        --input-border: #ccc;
        --status-initial-bg: #f3f4f6;
        --status-initial-border: #9ca3af;
        --status-pdf-bg: #d1fae5;
        --status-pdf-border: #10b981;
        --status-user-bg: #dbeafe;
        --status-user-border: var(--knicks-blue-accent);
        --status-attention-bg: #fffbeb;
        --status-attention-border: var(--knicks-orange-accent);
        --button-secondary-bg: #6b7280;
        --button-secondary-hover-bg: #4b5563;
        --debug-bg: #f9fafb;
        --debug-border: #e5e7eb;
        --modal-content-bg: #ffffff;
        --modal-viewer-bg: #e9ecef;
        --modal-header-border: #eee;
        --modal-text: #333;
        --loader-color: var(--company-pink);
        --header-bg: #ffffff;
        --photo-btn-bg: var(--knicks-blue-accent);
        --photo-btn-text: var(--text-light);
        --delete-icon-border: var(--text-light); /* Used for new ghost button */
        --delete-icon-fill: var(
          --text-light
        ); /* Used for new ghost button text */
      }

      html.dark-mode {
        --primary-bg: #1a202c;
        --secondary-bg: #2d3748;
        --text-primary: #e2e8f0;
        --text-secondary: #a0aec0;
        --border-color: #4a5568;
        --input-bg: #2d3748;
        --input-text: #e2e8f0;
        --input-border: #4a5568;
        --status-initial-bg: #3e4c5f;
        --status-initial-border: #718096;
        --status-pdf-bg: #2f5944;
        --status-pdf-border: #38a169;
        --status-user-bg: #2c5282;
        --status-attention-bg: #4c331a;
        --button-secondary-bg: #5a6268;
        --button-secondary-hover-bg: #495057;
        --debug-bg: #111722;
        --debug-border: var(--border-color);
        --modal-content-bg: var(--secondary-bg);
        --modal-viewer-bg: var(--primary-bg);
        --modal-header-border: var(--border-color);
        --modal-text: var(--text-primary);
        --header-bg: #2d3748;
        --photo-btn-bg: var(--knicks-orange-accent);
        --delete-icon-border: var(
          --text-primary
        ); /* Used for new ghost button in dark mode */
        --delete-icon-fill: var(
          --text-primary
        ); /* Used for new ghost button text in dark mode */
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Helvetica, Arial, sans-serif;
        padding: 20px;
        background-color: var(--primary-bg);
        color: var(--text-primary);
        line-height: 1.6;
        margin: 0;
        transition: background-color 0.3s ease, color 0.3s ease;
      }

      .app-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 15px 20px;
        background-color: var(--header-bg);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        margin-bottom: 20px;
        border-bottom: 1px solid var(--border-color);
      }

      .header-title-logo {
        display: flex;
        align-items: center;
      }
      .header-actions-wrapper {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .clear-report-button {
        background-color: var(--button-secondary-bg);
        color: var(--text-light);
        padding: 8px 12px;
        border-radius: 20px;
        font-size: 0.85em;
        font-weight: 600;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 6px;
        line-height: 1;
        transition: background-color 0.2s ease, filter 0.2s ease;
      }
      .clear-report-button:hover {
        filter: brightness(1.15);
      }
      .clear-report-button svg {
        fill: var(--text-light);
        width: 14px;
        height: 14px;
      }

      .main-title {
        font-size: 1.4em;
        color: var(--company-pink);
        margin: 0;
        font-weight: 700;
      }
      @media (max-width: 768px) {
        .main-title {
          font-size: 1.2em;
        }
        .app-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
          padding: 10px 15px;
        }
        .header-actions-wrapper {
          align-self: flex-end;
        }
        .top-field-group {
          flex-wrap: wrap;
        }
        .top-field-group > div {
          flex-basis: 100%;
          min-width: 100%;
          margin-bottom: 10px;
        }
        .top-field-group > div:last-child {
          margin-bottom: 0;
        }
        .photo-actions-container {
          flex-direction: column;
        }
        .photo-actions-container .photo-action-button {
          width: 100%;
          margin-bottom: 10px;
        }
        .photo-actions-container .photo-action-button:last-child {
          margin-bottom: 0;
        }
      }

      h2 {
        color: var(--text-primary);
        border-bottom: 1px solid var(--company-pink);
        padding-bottom: 5px;
        margin-top: 0;
        margin-bottom: 15px;
      }

      select,
      input[type="text"],
      input[type="number"],
      input[type="file"],
      textarea {
        width: 100%;
        padding: 10px;
        font-size: 16px;
        margin-top: 5px;
        background-color: var(--input-bg);
        color: var(--input-text);
        border: 1px solid var(--input-border);
        border-radius: 4px;
        box-sizing: border-box;
        transition: border-color 0.3s ease, background-color 0.3s ease,
          border-left-color 0.3s ease;
        border-left-width: 4px;
      }
      input[type="file"] {
        padding: 6px;
      }
      textarea {
        resize: vertical;
        min-height: 80px;
      }
      #generatedHyperlinkOutput {
        min-height: 90px;
        background-color: var(--primary-bg);
        font-family: monospace;
        font-size: 12px;
      }
      .no-comment-input {
        margin-top: 8px;
        min-height: 60px;
      }
      label {
        display: block;
        margin-top: 15px;
        font-weight: 600;
        color: var(--text-secondary);
      }
      input[type="checkbox"] {
        width: auto;
        margin-right: 8px;
        vertical-align: middle;
      }
      label.checkbox-label {
        display: inline-block;
        margin-top: 15px;
        font-weight: normal;
        color: var(--text-primary);
        cursor: pointer;
      }

      .field-group {
        display: flex;
        flex-wrap: nowrap;
        gap: 15px;
        align-items: flex-start;
      }
      .field-group > div {
        flex: 1;
        min-width: 150px;
      }
      .responsive-field-group {
        flex-wrap: wrap !important;
      }
      .responsive-field-group > div {
        min-width: 180px;
      }

      .top-field-group {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-start;
      }
      .top-field-group > div {
        flex: 1 1 250px;
        min-width: 200px;
      }

      .field-initial-default {
        background-color: var(--status-initial-bg);
        border-left-color: var(--status-initial-border);
      }
      .field-pdf-informed {
        background-color: var(--status-pdf-bg);
        border-left-color: var(--status-pdf-border);
      }
      .field-user-modified {
        background-color: var(--status-user-bg);
        border-left-color: var(--status-user-border);
      }
      .field-requires-attention {
        background-color: var(--status-attention-bg) !important;
        border-left-color: var(--status-attention-border) !important;
        font-weight: 500;
      }

      button { /* General button styling - will be overridden by .report-button if applied */
        margin-top: 20px;
        padding: 12px 20px;
        font-size: 16px;
        font-weight: 600;
        margin-right: 10px;
        background-color: var(--company-pink);
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.2s ease, transform 0.1s ease,
          filter 0.2s ease;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      button:hover {
        filter: brightness(1.1);
      }
      button:active {
        transform: scale(0.98);
      }
      button.secondary {
        background-color: var(--button-secondary-bg);
      }
      button.secondary:hover {
        filter: brightness(0.9);
      }
      /* Styles for the Create Report button, adapted from button3.html */
      .report-button { /* This is the primary class for the new button style */
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 12px 20px;
        font-size: 16px;
        font-weight: 600;
        border-radius: 8px;
        cursor: pointer;
        text-decoration: none;
        gap: 8px;
        transition: all 0.25s ease-out;
        min-width: 220px; /* From button3 */
        text-align: left; /* Align text to left when icon is present */
        border: 1px solid transparent; /* From button3 */
        position: relative;
        overflow: hidden; /* From button3 */
      }

      .report-button .button-text-content {
        flex-grow: 1; /* Allow text to take available space */
      }

      .report-button img.icon {
        height: 30px;
        width: auto;
        max-width: 70px; /* Approx 350/166 * 30px */
        object-fit: contain;
        margin-right: 8px; /* Space between icon and text */
      }

      .button-simple-pink { /* Specific style for pink button, adapted from button3.html */
        background-color: var(--company-pink); /* Use existing variable */
        color: var(--text-light); /* Text color for light mode */
        border: 1px solid var(--border-color); /* Use existing variable, or a more subtle one if defined */
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
      }

      html.dark-mode .button-simple-pink {
        color: var(--text-primary); /* Text color for dark mode for contrast */
        /* border-color can remain var(--border-color) as it also adapts for dark mode */
      }

      .button-simple-pink:hover {
        background-color: var(--knicks-blue-accent); /* Use existing variable */
        border-color: var(--knicks-blue-accent); /* Match border to bg on hover */
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        /* Text color on hover should remain consistent due to background change */
      }
      /* End of Create Report button styles */


      #viewPdfBtn {
        display: none;
        position: fixed;
        bottom: 20px;
        right: 20px;
        z-index: 1040;
        background-color: var(--company-pink);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        margin-top: 0;
        padding: 10px 15px;
        border-radius: 50px;
      }
      #viewPdfBtn:hover {
        filter: brightness(1.15);
      }

      pre {
        white-space: pre-wrap;
        word-wrap: break-word;
        background: var(--secondary-bg);
        color: var(--text-primary);
        padding: 15px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        margin-top: 20px;
        max-height: 400px;
        overflow-y: auto;
      }
      #pdfStatus {
        color: #48bb78;
        margin-top: 5px;
        font-size: 0.9em;
      }
      #pdfGenerateStatus,
      #sheetDataStatus,
      #palletDataStatus {
        min-height: 20px;
        margin-top: 10px;
        font-weight: 500;
      }
      #pdfGenerateStatus.success,
      #sheetDataStatus.success,
      #palletDataStatus.success {
        color: #48bb78;
      }
      #pdfGenerateStatus.error,
      #sheetDataStatus.error,
      #palletDataStatus.error {
        color: #fc8181;
      }

      .report-section {
        margin-bottom: 20px;
        padding: 20px;
        background: var(--secondary-bg);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        transition: background-color 0.3s ease, border-color 0.3s ease;
      }
      .question-item,
      .sheet-data-item {
        margin-bottom: 15px;
      }
      .no-comment-container {
        margin-top: 5px;
        padding-left: 10px;
        border-left: 3px solid var(--knicks-orange-accent);
      }

      .modal {
        display: none;
        position: fixed;
        z-index: 1050;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background-color: rgba(0, 0, 0, 0.7);
        align-items: center;
        justify-content: center;
      }
      .modal-content {
        background-color: var(--modal-content-bg);
        color: var(--modal-text);
        margin: auto;
        padding: 0;
        border: 1px solid var(--border-color);
        width: 90%;
        max-width: 800px;
        border-radius: 8px;
        position: relative;
        max-height: 90vh;
        display: flex;
        flex-direction: column;
      }
      .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 15px;
        border-bottom: 1px solid var(--modal-header-border);
        flex-shrink: 0;
      }
      .modal-header h3 {
        margin: 0;
        color: var(--company-pink);
        font-size: 1.1em;
      }
      .modal-close-button-fixed {
        color: var(--text-secondary);
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        background: none;
        border: none;
        padding: 0 5px;
        line-height: 1;
      }
      .modal-close-button-fixed:hover {
        color: var(--text-primary);
      }
      #pdfViewerContainer {
        width: 100%;
        flex-grow: 1;
        overflow-y: auto;
        background: var(--modal-viewer-bg);
        padding: 5px;
        text-align: center;
      }
      #pdfViewerContainer canvas {
        margin-bottom: 10px;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.15);
        max-width: 100%;
        height: auto !important;
        background-color: white;
      }
      .pdf-page-navigation {
        text-align: center;
        padding: 8px 0;
        background-color: var(--secondary-bg);
        border-top: 1px solid var(--border-color);
        flex-shrink: 0;
      }
      .pdf-page-navigation button {
        margin: 0 5px;
        padding: 8px 12px;
        font-size: 14px;
        margin-top: 0;
        background-color: var(--company-pink);
        color: white;
      }
      .pdf-page-navigation button:disabled {
        background-color: #5a6268;
        cursor: not-allowed;
      }
      .pdf-page-navigation span {
        color: var(--text-primary);
      }

      .output-group {
        margin-top: 15px;
      }
      .output-group label {
        font-size: 0.9em;
        color: var(--text-secondary);
      }
      .output-group textarea {
        min-height: 60px;
        background-color: var(--primary-bg);
        border-color: var(--border-color);
        margin-top: 2px;
      }

      .theme-switch-wrapper {
        display: flex;
        align-items: center;
        background-color: var(--secondary-bg);
        padding: 8px 12px;
        border-radius: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .theme-switch-wrapper label {
        margin: 0 8px 0 0;
        color: var(--text-primary);
        font-size: 0.85em;
        line-height: 1;
      }
      .theme-switch {
        display: inline-block;
        height: 22px;
        position: relative;
        width: 40px;
      }
      .theme-switch input {
        display: none;
      }
      .slider {
        background-color: #ccc;
        bottom: 0;
        cursor: pointer;
        left: 0;
        position: absolute;
        right: 0;
        top: 0;
        transition: 0.4s;
        border-radius: 22px;
      }
      .slider:before {
        background-color: #fff;
        bottom: 3px;
        content: "";
        height: 16px;
        left: 3px;
        position: absolute;
        transition: 0.4s;
        width: 16px;
        border-radius: 50%;
      }
      input:checked + .slider {
        background-color: var(--company-pink);
      }
      input:checked + .slider:before {
        transform: translateX(18px);
      }

      /* Photo Section Styles */
      #photoSection {
        margin-top: 20px;
      }
      .photo-actions-container {
        display: flex;
        gap: 10px;
        margin-bottom: 15px;
        flex-wrap: wrap;
      }
      .photo-action-button {
        flex: 1;
        padding: 10px 15px;
        background-color: var(--photo-btn-bg);
        color: var(--photo-btn-text);
        border-radius: 4px;
        text-align: center;
        cursor: pointer;
        font-weight: 600;
        border: none;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        min-width: 150px;
        margin-top: 0;
      }
      .photo-action-button:hover {
        filter: brightness(1.1);
      }
      .photo-action-button svg {
        fill: var(--photo-btn-text);
      }

      #cameraPhotoInput,
      #galleryPhotoInput {
        display: none;
      }

      #photoPreviews {
        display: flex;
        flex-direction: row;
        flex-wrap: wrap;
        gap: 8px;
        margin-top: 10px;
        border: 1px dashed var(--border-color);
        padding: 8px;
        min-height: 50px;
        border-radius: 4px;
        align-items: flex-start;
      }
      .photo-preview-item {
        position: relative;
        border: 1px solid var(--border-color);
        padding: 5px;
        border-radius: 4px;
        background-color: var(--secondary-bg);
        display: flex;
        flex-direction: column;
        width: 120px;
        max-width: 120px;
        box-sizing: border-box;
        height: auto;
      }
      .photo-preview-item.comments-enabled {
        width: 180px;
        max-width: 180px;
      }

      @media (max-width: 480px) {
        .photo-preview-item,
        .photo-preview-item.comments-enabled {
          width: calc(50% - 4px);
          max-width: none;
        }
      }

      .photo-preview-item img {
        max-width: 100%;
        height: auto;
        display: block;
        border-radius: 2px;
        margin-bottom: 5px;
        object-fit: cover;
        max-height: 100px;
      }
      .photo-preview-item.comments-enabled img {
        max-height: 150px;
      }

      .delete-photo-button {
        position: absolute;
        top: 5px;
        right: 5px;
        width: 24px;
        height: 24px;
        background-color: transparent;
        border: 1.5px solid var(--delete-icon-border);
        color: var(--delete-icon-fill);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-family: "Arial Black", Gadget, sans-serif;
        font-size: 12px;
        font-weight: bold;
        line-height: 1;
        padding: 0;
        transition: background-color 0.3s ease, transform 0.2s ease,
          border-color 0.3s ease, color 0.3s ease;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .delete-photo-button::before {
        content: "X";
      }
      .delete-photo-button:hover {
        background-color: rgba(
          255,
          0,
          0,
          0.7
        );
        border-color: var(--danger-red);
        color: var(--text-light);
        transform: scale(1.1);
      }

      .photo-comment-textarea {
        width: 100%;
        font-size: 12px;
        padding: 6px;
        margin-top: auto;
        min-height: 40px;
        box-sizing: border-box;
        border: 1px solid var(--input-border);
        border-radius: 3px;
        background-color: var(--input-bg);
        color: var(--input-text);
        display: none;
      }
      .photo-preview-item.comments-enabled .photo-comment-textarea {
        display: block;
      }

      .loader {
        border: 5px solid var(--input-bg);
        border-top: 5px solid var(--loader-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 20px auto;
        display: none;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .button-container {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
      }
      .hyperlink-config-section,
      .pallet-paper-section {
        margin-top: 30px;
      }
      .pallet-data-display div {
        margin-bottom: 5px;
        font-size: 0.95em;
      }
      .pallet-data-display span {
        font-weight: 600;
        color: var(--company-pink);
        padding-left: 5px;
      }

      .materials-input-container {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        align-items: flex-start;
        margin-top: 5px;
      }
      .material-item {
        display: flex;
        flex-direction: column;
        min-width: 100px;
        flex: 1;
      }
      .material-item label.material-label {
        font-size: 0.9em;
        margin-bottom: 3px;
        font-weight: normal;
        color: var(--text-secondary);
        display: block;
        margin-top: 0;
      }
      .material-item input.material-input {
        width: 100%;
        margin-right: 0;
        box-sizing: border-box;
      }

      @media (min-width: 500px) {
        .materials-input-container {
          flex-wrap: nowrap;
        }
        .material-item {
          flex-direction: row;
          align-items: center;
          gap: 5px;
        }
        .material-item label.material-label {
          margin-bottom: 0;
          white-space: nowrap;
        }
        .material-item input.material-input {
          width: 60px;
        }
      }
    </style>
  </head>
  <body>
    <header class="app-header">
      <div class="header-title-logo">
        <h1 class="main-title">Moving Report Generator</h1>
      </div>
      <div class="header-actions-wrapper">
        <button
          id="clearReportBtn"
          class="clear-report-button"
          title="Clear Report Data"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            class="bi bi-eraser-fill"
            viewBox="0 0 16 16"
          >
            <path
              d="M8.086 2.207a2 2 0 0 1 2.828 0l3.879 3.879a2 2 0 0 1 0 2.828l-5.5 5.5A2 2 0 0 1 7.879 15H5.12a2 2 0 0 1-1.414-.586l-2.5-2.5a2 2 0 0 1 0-2.828zm.66 11.34L3.453 8.254 1.914 9.793a1 1 0 0 0 0 1.414l2.5 2.5a1 1 0 0 0 .707.293H7.88a1 1 0 0 0 .707-.293z"
            />
          </svg>
          Clear Report
        </button>
        <div class="theme-switch-wrapper">
          <label for="themeToggle">Dark</label>
          <label class="theme-switch">
            <input type="checkbox" id="themeToggle" />
            <span class="slider"></span>
          </label>
        </div>
      </div>
    </header>

    <div style="padding: 0 20px">
      <div class="report-section">
        <div class="field-group top-field-group">
          <div>
            <label for="clientName">• Client Name:</label>
            <input
              type="text"
              id="clientName"
              placeholder="Enter client's name"
            />
          </div>
          <div>
            <label for="job">• Job number:</label>
            <input
              type="text"
              id="job"
              placeholder="Enter job number (Lead ID)"
            />
          </div>
          <div>
            <label for="cuFt">• CuFt:</label>
            <input type="text" id="cuFt" placeholder="Volume (e.g., 3655.00)" />
          </div>
        </div>
        <div>
          <label for="pdfFile" style="margin-top: 15px"
            >Upload PDF Inventory:</label
          >
          <input type="file" id="pdfFile" accept="application/pdf" />
          <div id="pdfStatus"></div>
        </div>
      </div>

      <div class="report-section" id="photoSection">
        <div
          style="
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
          "
        >
          <h2>Attach Photos for PDF Report</h2>
          <div>
            <input type="checkbox" id="enablePhotoCommentsToggle" />
            <label for="enablePhotoCommentsToggle" class="checkbox-label"
              >Enable Photo Comments</label
            >
          </div>
        </div>

        <div class="photo-actions-container">
          <button id="takePhotoButton" class="photo-action-button">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-camera-fill"
              viewBox="0 0 16 16"
            >
              <path d="M10.5 8.5a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0" />
              <path
                d="M2 4a2 2 0 0 0-2 2v6a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2h-1.172a2 2 0 0 1-1.414-.586l-.828-.828A2 2 0 0 0 9.172 2H6.828a2 2 0 0 0-1.414.586l-.828-.828A2 2 0 0 1 3.172 4zm.5 2a.5.5 0 1 1 0-1 .5.5 0 0 1 0 1m9-1a.5.5 0 1 0-1 0 .5.5 0 0 0 1 0"
              />
            </svg>
            Take Photo
          </button>
          <input
            type="file"
            id="cameraPhotoInput"
            accept="image/*"
            capture="environment"
          />

          <button id="uploadPhotosButton" class="photo-action-button">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="16"
              height="16"
              fill="currentColor"
              class="bi bi-images"
              viewBox="0 0 16 16"
            >
              <path d="M4.502 9a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3" />
              <path
                d="M14.002 13a2 2 0 0 1-2 2h-10a2 2 0 0 1-2-2V5A2 2 0 0 1 2 3a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2v8a2 2 0 0 1-1.998 2M14 2H4a1 1 0 0 0-1 1h9.002a2 2 0 0 1 2 2v7A1 1 0 0 0 15 11V3a1 1 0 0 0-1-1M2.002 4a1 1 0 0 0-1 1v8l2.646-2.354a.5.5 0 0 1 .63-.062l2.66 1.773 3.71-3.71a.5.5 0 0 1 .577-.094l1.777 1.947V5a1 1 0 0 0-1-1z"
              />
            </svg>
            Upload Photos
          </button>
          <input type="file" id="galleryPhotoInput" accept="image/*" multiple />
        </div>
        <div id="photoPreviews"></div>
      </div>

      <div id="fields" class="report-section">
        <h2>Report Details</h2>
      </div>

      <div class="report-section">
        <label for="generalComments">Additional General Comments:</label>
        <textarea
          id="generalComments"
          rows="3"
          placeholder="Enter any other comments here"
        ></textarea>
      </div>

      <div class="report-section">
        <label for="rating">Rating (1.0 - 5.0):</label>
        <input
          type="number"
          id="rating"
          value="4.0"
          min="1"
          max="5"
          step="0.1"
          placeholder="e.g., 4.5"
        />
      </div>

      <div class="report-section">
        <h2>Data for Google Sheets Cell</h2>
        <div class="sheet-data-item">
          <label for="sheetWarehouse">Warehouse:</label>
          <select id="sheetWarehouse">
            <option value="">Select Warehouse</option>
            <option value="Masp1">Masp1</option>
            <option value="Masp2">Masp2</option>
            <option value="Masp3">Masp3</option>
            <option value="Masp4">Masp4</option>
            <option value="TRAF">TRAF</option>
            <option value="LIC">LIC</option>
            <option value="SKIL">SKIL</option>
            <option value="BRON">BRON</option>
            <option value="WTPL">WTPL</option>
            <option value="ROS">ROS</option>
            <option value="HALE">HALE</option>
            <option value="PASS">PASS</option>
            <option value="OtherWH">Other (Specify)</option>
          </select>
        </div>
        <div class="sheet-data-item">
          <input type="checkbox" id="useLoadingDock" style="margin-top: 10px" />
          <label for="useLoadingDock" class="checkbox-label"
            >Use "loading dock" for Address</label
          >
          <label for="sheetAddress" style="margin-top: 5px"
            >Location/Address (e.g., A23R):</label
          >
          <input
            type="text"
            id="sheetAddress"
            placeholder="e.g., A23R or Street Address"
          />
        </div>

        <div class="field-group responsive-field-group">
          <div class="sheet-data-item" style="flex: 1 1 180px">
            <label for="sheetPallets">Pallets:</label>
            <input
              type="number"
              id="sheetPallets"
              placeholder="e.g., 2"
              min="0"
            />
          </div>
          <div class="sheet-data-item" style="flex: 1 1 180px">
            <label for="sheetItems">Items:</label>
            <input
              type="number"
              id="sheetItems"
              placeholder="e.g., 20"
              min="0"
            />
            <small
              id="pdfItemCount"
              style="
                color: var(--text-secondary);
                display: block;
                margin-top: 3px;
              "
            ></small>
          </div>
          <div class="sheet-data-item" style="flex: 1 1 180px">
            <label for="sheetEmployeeName">Employee Name:</label>
            <input type="text" id="sheetEmployeeName" placeholder="Your Name" />
          </div>
        </div>

        <div class="sheet-data-item">
          <input type="checkbox" id="sheetBingoStatusOK" checked />
          <label for="sheetBingoStatusOK" class="checkbox-label"
            >Inventory OK (Bingo)?</label
          >
          <div
            id="sheetBingoDetailsContainer"
            style="display: none; margin-top: 5px"
          >
            <label for="sheetBingoDetails"
              >Bingo Issues (e.g., #34v, #3m):</label
            >
            <input
              type="text"
              id="sheetBingoDetails"
              placeholder="#ID void/missing"
            />
          </div>
        </div>
        <div class="sheet-data-item">
          <label>Materials (approx. from PDF, please verify):</label>
          <div class="materials-input-container">
            <div class="material-item">
              <label for="sheetMatTV" class="material-label">TV Boxes:</label>
              <input
                type="number"
                id="sheetMatTV"
                placeholder="0"
                min="0"
                class="material-input"
              />
            </div>
            <div class="material-item">
              <label for="sheetMatWR" class="material-label">Wardrobes:</label>
              <input
                type="number"
                id="sheetMatWR"
                placeholder="0"
                min="0"
                class="material-input"
              />
            </div>
            <div class="material-item">
              <label for="sheetMatBL" class="material-label">Blankets:</label>
              <input
                type="number"
                id="sheetMatBL"
                placeholder="0"
                min="0"
                class="material-input"
              />
            </div>
          </div>
          <small
            id="pdfMaterialCounts"
            style="
              color: var(--text-secondary);
              display: block;
              margin-top: 3px;
            "
          ></small>
        </div>

        <div class="output-group">
          <label for="sheetOutputString"
            >Formatted String for Google Sheets:</label
          >
          <textarea id="sheetOutputString" readonly rows="2"></textarea>
          <div
            style="
              margin-top: 10px;
              display: flex;
              flex-wrap: wrap;
              gap: 10px;
              align-items: center;
            "
          >
            <button onclick="copySheetString()" style="margin-top: 0">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="16"
                height="16"
                fill="currentColor"
                class="bi bi-clipboard-check"
                viewBox="0 0 16 16"
              >
                <path
                  fill-rule="evenodd"
                  d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0"
                />
                <path
                  d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"
                />
                <path
                  d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5zm-3-1A1.5 1.5 0 0 0 5 1.5v1A1.5 1.5 0 0 0 6.5 4h3A1.5 1.5 0 0 0 11 2.5v-1A1.5 1.5 0 0 0 9.5 0z"
                />
              </svg>
              Copy Sheet String
            </button>
            <button
              id="createShareReportBtn"
              class="report-button button-simple-pink"
              onclick="generatePdfWithPhotos()"
              style="margin-top: 0"
            >
              <img src="" alt="Logo" class="icon" id="reportButtonIcon" style="display: none;">
              <span class="button-text-content">Create Report</span>
            </button>
          </div>
          <div
            id="pdfGenerateLoader"
            class="loader"
            style="margin-left: 0; margin-right: auto; margin-top: 10px"
          ></div>
          <div id="pdfGenerateStatus"></div>
          <div id="sheetDataStatus"></div>
        </div>
      </div>

      <button id="viewPdfBtn" onclick="openPdfModal()">
        <svg
          xmlns="http://www.w3.org/2000/svg"
          width="16"
          height="16"
          fill="currentColor"
          class="bi bi-eye-fill"
          viewBox="0 0 16 16"
        >
          <path d="M10.5 8a2.5 2.5 0 1 1-5 0 2.5 2.5 0 0 1 5 0" />
          <path
            d="M0 8s3-5.5 8-5.5S16 8 16 8s-3 5.5-8 5.5S0 8 0 8m8 3.5a3.5 3.5 0 1 0 0-7 3.5 3.5 0 0 0 0 7"
          />
        </svg>
        View PDF
      </button>

      <div id="pdfModal" class="modal">
        <div class="modal-content">
          <div class="modal-header">
            <h3>Uploaded PDF Document</h3>
            <span
              class="modal-close-button-fixed"
              onclick="closePdfModalWithHistory()"
              title="Close PDF Viewer"
              >&times;</span
            >
          </div>
          <div id="pdfViewerContainer"></div>
          <div class="pdf-page-navigation">
            <button id="prevPage">Previous</button>
            <span
              >Page <span id="currentPageNum">0</span> of
              <span id="totalPagesNum">0</span></span
            >
            <button id="nextPage">Next</button>
          </div>
        </div>
      </div>

      <div class="report-section hyperlink-config-section">
        <h2>Google Sheets Hyperlink Formula Generator</h2>
        <div class="sheet-data-item">
          <label for="spreadsheetIdInput">Spreadsheet ID:</label>
          <input
            type="text"
            id="spreadsheetIdInput"
            placeholder="Enter Google Spreadsheet ID (will be saved)"
          />
        </div>
        <div class="sheet-data-item">
          <label for="sheetNameInput">Sheet Name (e.g., MM/DD/YYYY):</label>
          <input
            type="text"
            id="sheetNameInput"
            placeholder="Default: current date"
          />
        </div>
        <div class="sheet-data-item">
          <label for="startRowInput"
            >Start Row for Formula in Sheet (e.g., 6):</label
          >
          <input
            type="number"
            id="startRowInput"
            value="6"
            min="1"
            placeholder="Enter starting row number"
          />
        </div>
        <button onclick="generateSheetFormula()">
          Generate Google Sheets Formula
        </button>
        <div class="output-group" style="margin-top: 10px">
          <label for="generatedHyperlinkOutput"
            >Copy this formula into the first cell (e.g., A6) and drag
            down:</label
          >
          <textarea id="generatedHyperlinkOutput" readonly rows="4"></textarea>
        </div>
      </div>

      <div class="report-section pallet-paper-section">
        <h2>Data for Pallet Paper</h2>
        <div class="pallet-data-display">
          <div>Job Number: <span id="palletJobNumber"></span></div>
          <div>Client Name: <span id="palletClientName"></span></div>
          <div>Date: <span id="palletCurrentDate"></span></div>
        </div>
        <button onclick="copyPalletData()">
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="16"
            height="16"
            fill="currentColor"
            class="bi bi-clipboard-plus"
            viewBox="0 0 16 16"
          >
            <path
              fill-rule="evenodd"
              d="M8 7a.5.5 0 0 1 .5.5V9H10a.5.5 0 0 1 0 1H8.5v1.5a.5.5 0 0 1-1 0V10H6a.5.5 0 0 1 0-1h1.5V7.5A.5.5 0 0 1 8 7"
            />
            <path
              d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1 1V14a1 1 0 0 1-1 1H3a1 1 0 0 1-1-1V3.5a1 1 0 0 1 1-1h1z"
            />
            <path
              d="M9.5 1a.5.5 0 0 1 .5.5v1a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-1a.5.5 0 0 1 .5-.5z"
            />
          </svg>
          Copy for Pallet Paper
        </button>
        <div id="palletDataStatus"></div>
      </div>
    </div>
    <script>
      if (typeof pdfjsLib === "undefined") {
        console.error("PDF.js library is not loaded!");
      } else {
        pdfjsLib.GlobalWorkerOptions.workerSrc =
          "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js";
      }
      if (typeof jspdf === "undefined") {
        console.error("jsPDF library is not loaded!");
      }

      let loadedPdfDocument = null;
      let currentPageInView = 1;
      const attentionFieldIds = []; // "wooden" removed
      const sheetDataInputIds = [
        "sheetWarehouse",
        "sheetAddress",
        "sheetPallets",
        "sheetItems",
        "sheetEmployeeName",
        "sheetBingoStatusOK",
        "sheetBingoDetails",
        "sheetMatTV",
        "sheetMatWR",
        "sheetMatBL",
        "useLoadingDock",
      ];
      let selectedPhotos = [];
      let cameraPhotoCounter = 0;

      const questions = [
        {
          id: "sofa",
          text: "Sofa is full shrinked and wrapped in blankets:",
          options: ["YES", "NO", "NO SOFA"],
          itemName: "Sofa",
        },
        {
          id: "mattress",
          text: "Mattress in box, full shrinked and wrapped in blankets:",
          options: ["YES", "NO", "NO MATTRESS"],
          itemName: "Mattress",
        },
        {
          id: "wardrobe",
          text: "Wardrobe with only clothes/pillows inside:",
          options: ["YES", "NO", "NO WARDROBE"],
          itemName: "Wardrobe",
        },
        {
          id: "tvbox",
          text: "TV Box with only TV or Paintings inside:",
          options: ["YES", "NO", "NO TV BOX"],
          itemName: "TV Box",
        },
        {
          id: "paintings",
          text: "Paintings or glass in TV Box are separated from each other by boxes:",
          options: ["YES", "NO", "NO PAINTING/GLASS"],
          itemName: "Paintings/Glass",
        },
        {
          id: "corners",
          text: "Corners/Cardboard are placed on all furniture where required:",
          options: ["YES", "NO"],
          itemName: "Corners/Cardboard",
        },
        {
          id: "wooden",
          text: "Wooden items are full wrapped in blankets:",
          options: ["YES", "NO", "NO WOODEN PARTS"],
          itemName: "Wooden Items",
        },
        {
          id: "leather",
          text: "Leather items are wrapped in blankets without shrink:",
          options: ["YES", "NO", "NO LEATHER ITEMS"],
          itemName: "Leather Items",
        },
        {
          id: "suitcases",
          text: "Suitcases are full shrinked:",
          options: ["YES", "NO", "NO SUITCASES"],
          itemName: "Suitcases",
        },
        {
          id: "lamps",
          text: "Lamps in Boxes/Bubble wrap/wrapped in blankets:",
          options: ["YES", "NO", "NO LAMPS"],
          itemName: "Lamps",
        },
        {
          id: "bikes",
          text: "Bicycle/Peloton is full wrapped in blankets:",
          options: ["YES", "NO", "NO BIKES"],
          itemName: "Bicycle/Peloton",
        },
        {
          id: "rugs",
          text: "Rugs/Carpets are full shrinked:",
          options: ["YES", "NO", "NO RUGS"],
          itemName: "Rugs/Carpets",
        },
        {
          id: "hardware",
          text: "Hardware Box:",
          options: ["YES", "NO"],
          itemName: "Hardware Box",
        },
      ];
      const defaultValuesConfig = {
        sofa: "NO SOFA",
        mattress: "NO MATTRESS",
        wardrobe: "NO WARDROBE",
        tvbox: "NO TV BOX",
        paintings: "NO PAINTING/GLASS",
        corners: "YES",
        wooden: "YES",
        leather: "NO LEATHER ITEMS",
        suitcases: "NO SUITCASES",
        lamps: "NO LAMPS",
        bikes: "NO BIKES",
        rugs: "NO RUGS",
        hardware: "YES",
      };
      const keywordMap = {
        sofa: [
          "sofa",
          "couch",
          "ottoman",
          "loveseat",
          "settee",
          "sectional",
          "sofa bed",
        ],
        mattress: ["mattress", "box spring", "boxspring"],
        wardrobe: ["wardrobe", "wardrobe box", "armoire"],
        tvbox: ["tv box", "tvbox"],
        paintings: ["painting", "glass", "picture", "art", "canvas", "mirror"],
        leather: ["leather"],
        suitcases: ["suitcase"],
        lamps: ["lamp"],
        bikes: ["bike", "bicycle", "peloton", "exercise bike"],
        rugs: ["rug", "carpet"],
        hardware: ["hardware", "hardware box"],
      };

      const fieldContainer = document.getElementById("fields");
      const allInputElementsForReset = [];

      function applyCurrentTheme() {
        const themeToggleCheckbox = document.getElementById("themeToggle");
        const savedTheme = localStorage.getItem("theme");
        if (themeToggleCheckbox) {
          if (savedTheme === "dark-mode") {
            document.documentElement.classList.add("dark-mode");
            themeToggleCheckbox.checked = true;
          } else {
            document.documentElement.classList.remove("dark-mode");
            themeToggleCheckbox.checked = false;
            if (!savedTheme) localStorage.setItem("theme", "light-mode");
          }
        }
      }
      function setupThemeToggle() {
        const themeToggleCheckbox = document.getElementById("themeToggle");
        if (themeToggleCheckbox) {
          themeToggleCheckbox.addEventListener("change", function () {
            if (this.checked) {
              document.documentElement.classList.add("dark-mode");
              localStorage.setItem("theme", "dark-mode");
            } else {
              document.documentElement.classList.remove("dark-mode");
              localStorage.setItem("theme", "light-mode");
            }
          });
        }
      }

      function applyAttentionHighlight(element) {
        if (!element) return;
        element.classList.remove("field-requires-attention");
        if (
          attentionFieldIds.includes(element.id) &&
          element.value === "YES" &&
          element.dataset.status !== "user-modified"
        ) {
          element.classList.add("field-requires-attention");
        }
      }

      function setFieldStatus(element, status) {
        if (!element) {
          return;
        }
        element.classList.remove(
          "field-initial-default",
          "field-pdf-informed",
          "field-user-modified",
          "field-requires-attention"
        );
        if (status) element.classList.add(`field-${status}`);
        element.dataset.status = status;
        applyAttentionHighlight(element);
      }

      function getCurrentDateFormatted(separator = "") {
        const today = new Date();
        const year = today.getFullYear();
        const month = String(today.getMonth() + 1).padStart(2, "0");
        const day = String(today.getDate()).padStart(2, "0");
        return `${year}${separator}${month}${separator}${day}`;
      }

      document.addEventListener("DOMContentLoaded", () => {
        applyCurrentTheme();
        setupThemeToggle();
        processUrlParameters();

        const sheetNameInput = document.getElementById("sheetNameInput");
        if (sheetNameInput && !sheetNameInput.value) {
          sheetNameInput.value = getCurrentDateFormatted("/");
        }
        const spreadsheetIdInput =
          document.getElementById("spreadsheetIdInput");
        if (spreadsheetIdInput) {
          const savedSpreadsheetId = localStorage.getItem("spreadsheetId");
          if (savedSpreadsheetId) {
            spreadsheetIdInput.value = savedSpreadsheetId;
          }
          spreadsheetIdInput.addEventListener("input", () => {
            localStorage.setItem("spreadsheetId", spreadsheetIdInput.value);
          });
        }

        if (fieldContainer) {
          questions.forEach((q) => {
            const questionDiv = document.createElement("div");
            questionDiv.className = "question-item";
            const label = document.createElement("label");
            label.htmlFor = q.id;
            label.textContent = "• " + q.text;
            questionDiv.appendChild(label);
            const select = document.createElement("select");
            select.id = q.id;
            select.dataset.itemId = q.id;
            select.dataset.itemName = q.itemName;
            q.options.forEach((optText) => {
              const o = document.createElement("option");
              o.text = optText;
              o.value = optText;
              select.add(o);
            });
            questionDiv.appendChild(select);
            allInputElementsForReset.push(select);
            const commentContainer = document.createElement("div");
            commentContainer.id = `no_comment_container_${q.id}`;
            commentContainer.className = "no-comment-container";
            commentContainer.style.display = "none";
            const commentTextarea = document.createElement("textarea");
            commentTextarea.id = `no_comment_textarea_${q.id}`;
            commentTextarea.className = "no-comment-input";
            commentTextarea.placeholder = `Details for ${q.itemName} (NO)...`;
            commentContainer.appendChild(commentTextarea);
            questionDiv.appendChild(commentContainer);
            allInputElementsForReset.push(commentTextarea);
            fieldContainer.appendChild(questionDiv);
            select.addEventListener("change", (event) => {
              handleNoSelection(event);
              setFieldStatus(select, "user-modified");
            });
            commentTextarea.addEventListener("input", () => {
              setFieldStatus(commentTextarea, "user-modified");
            });
            if (defaultValuesConfig[q.id]) {
              select.value = defaultValuesConfig[q.id];
            }
            setFieldStatus(select, "initial-default");
            setFieldStatus(commentTextarea, "initial-default");
            if (select.value === "NO") {
              select.dispatchEvent(new Event("change"));
            }
          });
        }
        ["clientName", "job", "cuFt", "generalComments", "rating"].forEach(
          (id) => {
            const element = document.getElementById(id);
            if (element) {
              allInputElementsForReset.push(element);
              const eventType =
                element.tagName === "SELECT" || element.type === "number"
                  ? "change"
                  : "input";
              element.addEventListener(eventType, () =>
                setFieldStatus(element, "user-modified")
              );
              if (!element.value) {
                setFieldStatus(element, "initial-default");
              }
            }
          }
        );

        const useLoadingDockCheckbox =
          document.getElementById("useLoadingDock");
        const sheetAddressInput = document.getElementById("sheetAddress");
        if (useLoadingDockCheckbox && sheetAddressInput) {
          useLoadingDockCheckbox.addEventListener("change", function () {
            if (this.checked) {
              sheetAddressInput.value = "loading dock";
              sheetAddressInput.disabled = true;
              setFieldStatus(sheetAddressInput, "user-modified");
            } else {
              sheetAddressInput.value = "";
              sheetAddressInput.disabled = false;
              setFieldStatus(sheetAddressInput, "initial-default");
            }
            updateSheetOutputString();
          });
        }

        sheetDataInputIds.forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener("input", updateSheetOutputString);
            element.addEventListener("change", updateSheetOutputString);
            if (id === "sheetEmployeeName" || id === "sheetWarehouse") {
              element.addEventListener("change", saveSheetDataToLocalStorage);
            }
          }
        });
        const bingoCheckboxInit = document.getElementById("sheetBingoStatusOK");
        if (bingoCheckboxInit) {
          bingoCheckboxInit.addEventListener("change", function () {
            const detailsContainer = document.getElementById(
              "sheetBingoDetailsContainer"
            );
            const detailsInput = document.getElementById("sheetBingoDetails");
            if (detailsContainer)
              detailsContainer.style.display = this.checked ? "none" : "block";
            if (this.checked && detailsInput) {
              detailsInput.value = "";
            }
            updateSheetOutputString();
          });
        }
        loadSheetDataFromLocalStorage();
        updateSheetOutputString();
        const bingoStatusElInit = document.getElementById("sheetBingoStatusOK");
        const bingoDetailsContainerElInit = document.getElementById(
          "sheetBingoDetailsContainer"
        );
        if (bingoStatusElInit && bingoDetailsContainerElInit) {
          bingoDetailsContainerElInit.style.display = !bingoStatusElInit.checked
            ? "block"
            : "none";
        }

        const pdfFileInput = document.getElementById("pdfFile");
        if (pdfFileInput) {
          pdfFileInput.addEventListener("change", handlePdfFileChange);
        }

        const takePhotoButton = document.getElementById("takePhotoButton");
        const cameraPhotoInput = document.getElementById("cameraPhotoInput");
        const uploadPhotosButton =
          document.getElementById("uploadPhotosButton");
        const galleryPhotoInput = document.getElementById("galleryPhotoInput");

        if (takePhotoButton) {
          takePhotoButton.addEventListener("click", () => {
            const jobInput = document.getElementById("job");
            if (!jobInput || !jobInput.value.trim()) {
              alert("Please enter a Job Number before taking a photo.");
              return;
            }
            cameraPhotoInput.click();
          });
        }
        if (cameraPhotoInput) {
          cameraPhotoInput.addEventListener("change", (event) =>
            processSelectedFiles(event, true)
          );
        }
        if (uploadPhotosButton) {
          uploadPhotosButton.addEventListener("click", () =>
            galleryPhotoInput.click()
          );
        }
        if (galleryPhotoInput) {
          galleryPhotoInput.addEventListener("change", (event) =>
            processSelectedFiles(event, false)
          );
        }

        const enablePhotoCommentsToggle = document.getElementById(
          "enablePhotoCommentsToggle"
        );
        if (enablePhotoCommentsToggle) {
          enablePhotoCommentsToggle.addEventListener(
            "change",
            togglePhotoCommentFields
          );
        }

        window.addEventListener("popstate", function (event) {
          const pdfModal = document.getElementById("pdfModal");
          if (
            pdfModal &&
            pdfModal.style.display === "flex" &&
            event.state &&
            event.state.pdfModalOpen
          ) {
            closePdfModal(false);
          }
        });
        const prevPageBtn = document.getElementById("prevPage");
        if (prevPageBtn)
          prevPageBtn.addEventListener("click", () => {
            if (currentPageInView > 1)
              displayPdfPageInModal(currentPageInView - 1);
          });
        const nextPageBtn = document.getElementById("nextPage");
        if (nextPageBtn)
          nextPageBtn.addEventListener("click", () => {
            if (
              loadedPdfDocument &&
              currentPageInView < loadedPdfDocument.numPages
            )
              displayPdfPageInModal(currentPageInView + 1);
          });

        const clearReportBtn = document.getElementById("clearReportBtn");
        if (clearReportBtn)
          clearReportBtn.addEventListener("click", clearReportData);

        // Setup for Create Report button icon
        const reportButtonIcon = document.getElementById('reportButtonIcon');
        if (reportButtonIcon) {
            const iconImagePreloader = new Image();
            iconImagePreloader.onload = function() {
                reportButtonIcon.src = 'logo.png';
                reportButtonIcon.style.display = 'inline';
            };
            iconImagePreloader.onerror = function() {
                reportButtonIcon.style.display = 'none';
            };
            iconImagePreloader.src = 'logo.png'; // Path to your logo
        }
      });

      function processUrlParameters() {
        const urlParams = new URLSearchParams(window.location.search);

        const spreadsheetIdFromUrl = urlParams.get("spreadsheetId");
        const sheetNameFromUrl = urlParams.get("sheetName");
        const rowFromUrl = urlParams.get("row");
        const leadIdFromUrl = urlParams.get("leadId");
        const customerNameFromUrl = urlParams.get("customerName");
        const volumeFromUrl = urlParams.get("volume");

        if (spreadsheetIdFromUrl) {
          const el = document.getElementById("spreadsheetIdInput");
          if (el) el.value = spreadsheetIdFromUrl;
        }
        if (sheetNameFromUrl) {
          const el = document.getElementById("sheetNameInput");
          if (el) el.value = sheetNameFromUrl;
        }
        if (rowFromUrl) {
          const el = document.getElementById("startRowInput");
          if (el) el.value = rowFromUrl;
        }
        if (leadIdFromUrl) {
          const el = document.getElementById("job");
          if (el) {
            el.value = leadIdFromUrl;
            setFieldStatus(el, "pdf-informed");
          }
        }
        if (customerNameFromUrl) {
          const el = document.getElementById("clientName");
          if (el) {
            el.value = customerNameFromUrl;
            setFieldStatus(el, "pdf-informed");
          }
        }
        if (volumeFromUrl) {
          const el = document.getElementById("cuFt");
          if (el) {
            el.value = volumeFromUrl;
            setFieldStatus(el, "pdf-informed");
          }
        }
      }

      function generateSheetFormula() {
        const baseUrl = window.location.href.split("?")[0];
        const spreadsheetId =
          document.getElementById("spreadsheetIdInput").value;
        const sheetName = document.getElementById("sheetNameInput").value;
        const startRow = document.getElementById("startRowInput").value;

        if (!startRow || parseInt(startRow) < 1) {
          // alert("Please enter a valid Start Row number (e.g., 6).");
          // return;
        }
        const leadIdCellRef = `B${startRow}`;
        const customerNameCellRef = `C${startRow}`;
        const volumeCellRef = `E${startRow}`;
        const selfRowCellRef = `A${startRow}`;
        const googleSheetsFormula = `=HYPERLINK("${baseUrl}?spreadsheetId="&ENCODEURL("${spreadsheetId}")&"&sheetName="&ENCODEURL("${sheetName}")&"&row="&ROW(${selfRowCellRef})&"&leadId="&ENCODEURL(${leadIdCellRef})&"&customerName="&ENCODEURL(${customerNameCellRef})&"&volume="&ENCODEURL(${volumeCellRef}), "Open ("&${leadIdCellRef}&")")`;

        document.getElementById("generatedHyperlinkOutput").value =
          googleSheetsFormula;
      }

      function togglePhotoCommentFields() {
        const photoPreviewsContainer = document.getElementById("photoPreviews");
        const isEnabled = document.getElementById(
          "enablePhotoCommentsToggle"
        ).checked;
        if (photoPreviewsContainer) {
          const items =
            photoPreviewsContainer.getElementsByClassName("photo-preview-item");
          for (let item of items) {
            if (isEnabled) {
              item.classList.add("comments-enabled");
            } else {
              item.classList.remove("comments-enabled");
            }
          }
        }
      }

      function handleNoSelection(event) {
        const selectElement = event.target;
        const itemId = selectElement.dataset.itemId;
        const itemName = selectElement.dataset.itemName;
        const commentContainer = document.getElementById(
          `no_comment_container_${itemId}`
        );
        const commentTextarea = document.getElementById(
          `no_comment_textarea_${itemId}`
        );
        const noCommentTemplate = `${itemName} (NO): `;
        if (selectElement.value === "NO") {
          if (
            commentTextarea &&
            (commentTextarea.value.trim() === "" ||
              commentTextarea.dataset.status !== "user-modified")
          ) {
            commentTextarea.value = noCommentTemplate;
          }
          if (commentContainer) commentContainer.style.display = "block";
        } else {
          if (commentContainer) commentContainer.style.display = "none";
        }
      }

      async function readPDF(file) {
        const buffer = await file.arrayBuffer();
        const pdfDoc = await pdfjsLib.getDocument({ data: buffer }).promise;
        loadedPdfDocument = pdfDoc;
        let fullText = "";
        for (let i = 1; i <= pdfDoc.numPages; i++) {
          const page = await pdfDoc.getPage(i);
          const content = await page.getTextContent();
          fullText += content.items.map((item) => item.str).join(" ") + "\n";
        }
        const inventoryLines = fullText.toLowerCase().split("\n");
        const itemCountMatch = fullText.match(/Number of Pieces\s*:\s*(\d+)/i);
        const itemCountEl = document.getElementById("sheetItems");
        const pdfItemCountEl = document.getElementById("pdfItemCount");

        const cuFtEl = document.getElementById("cuFt");
        const cuFtRegexPatterns = [
          /Total Cu\. Ft\.\s*:\s*([\d,]+\.?\d*)/i,
          /Est\. Total Cu\. Ft\.\s*:\s*([\d,]+\.?\d*)/i,
          /CUFT\s*[:\s]*([\d,]+\.?\d*)/i,
          /Volume\s*[:\s]*([\d,]+\.?\d*)\s*CuFt/i,
        ];
        let cuFtValue = "";
        for (const pattern of cuFtRegexPatterns) {
          const cuFtMatch = fullText.match(pattern);
          if (cuFtMatch && cuFtMatch[1]) {
            cuFtValue = cuFtMatch[1];
            break;
          }
        }
        if (cuFtEl && !cuFtEl.value) {
          cuFtEl.value = cuFtValue;
          setFieldStatus(
            cuFtEl,
            cuFtValue ? "pdf-informed" : "initial-default"
          );
        }

        if (itemCountEl) {
          if (itemCountMatch && itemCountMatch[1]) {
            itemCountEl.value = itemCountMatch[1];
            if (pdfItemCountEl)
              pdfItemCountEl.textContent = `(PDF says: ${itemCountMatch[1]} pieces)`;
            setFieldStatus(itemCountEl, "pdf-informed");
          } else {
            if (pdfItemCountEl)
              pdfItemCountEl.textContent = "(Item count not found in PDF)";
            setFieldStatus(itemCountEl, "initial-default");
          }
        }
        let tvCount = 0;
        let wrCount = 0;
        let blCount = 0;
        inventoryLines.forEach((line) => {
          if (
            /\b(tv box|tvbox)\b/i.test(line) &&
            !/content|description|header/i.test(line.substring(0, 30))
          )
            tvCount++;
          if (
            /\b(wardrobe box)\b/i.test(line) &&
            !/content|description|header/i.test(line.substring(0, 30))
          )
            wrCount++;
          if (
            /\b(blanket|blankets)\b/i.test(line) &&
            (line.includes("pack type") || line.split(/\s\s+/).length > 3) &&
            !/content|description|header/i.test(line.substring(0, 30))
          )
            blCount++;
        });
        const sheetMatTVEl = document.getElementById("sheetMatTV");
        const sheetMatWREl = document.getElementById("sheetMatWR");
        const sheetMatBLEl = document.getElementById("sheetMatBL");
        if (sheetMatTVEl) {
          sheetMatTVEl.value = tvCount > 0 ? tvCount : "";
          setFieldStatus(
            sheetMatTVEl,
            tvCount > 0 ? "pdf-informed" : "initial-default"
          );
        }
        if (sheetMatWREl) {
          sheetMatWREl.value = wrCount > 0 ? wrCount : "";
          setFieldStatus(
            sheetMatWREl,
            wrCount > 0 ? "pdf-informed" : "initial-default"
          );
        }
        if (sheetMatBLEl) {
          sheetMatBLEl.value = blCount > 0 ? blCount : "";
          setFieldStatus(
            sheetMatBLEl,
            blCount > 0 ? "pdf-informed" : "initial-default"
          );
        }
        const pdfMaterialCountsEl =
          document.getElementById("pdfMaterialCounts");
        if (pdfMaterialCountsEl)
          pdfMaterialCountsEl.textContent = `(Approx. PACK TYPES: ${tvCount} TV Box, ${wrCount} Wardrobe Box, ${blCount} Blanket-Wrapped Items)`;
        updateSheetOutputString();
        return fullText;
      }

      async function handlePdfFileChange(e) {
        const file = e.target.files[0];
        const pdfStatus = document.getElementById("pdfStatus");
        const viewPdfBtn = document.getElementById("viewPdfBtn");
        loadedPdfDocument = null;
        if (viewPdfBtn) viewPdfBtn.style.display = "none";
        if (!file) {
          if (pdfStatus) pdfStatus.textContent = "No file selected.";
          return;
        }
        if (pdfStatus) pdfStatus.textContent = `Loading ${file.name}...`;
        try {
          const rawText = await readPDF(file);
          if (pdfStatus)
            pdfStatus.textContent = `Successfully loaded: ${file.name}`;
          if (viewPdfBtn) viewPdfBtn.style.display = "inline-block";
          currentPageInView = 1;
          let jobNumber = "",
            clientName = "";
          const jobRegexPatterns = [
            /Shipment Number\s*.*?(\b\d{5,}\b)/i,
            /Job number\s*.*?(\b\d{5,}\b)/i,
          ];
          for (const pattern of jobRegexPatterns) {
            const jobMatch = rawText.match(pattern);
            if (jobMatch && jobMatch[1]) {
              jobNumber = jobMatch[1];
              break;
            }
          }
          if (!jobNumber) {
            const simpleJobMatch = rawText.match(
              /(?:Shipment Number|Job number)\s*(\d{5,})/i
            );
            if (simpleJobMatch && simpleJobMatch[1]) {
              jobNumber = simpleJobMatch[1];
            }
          }
          const shipperNameRegex =
            /(?:S|H)IPPER\s*([A-Za-z][A-Za-z\s'-]*[A-Za-z])(?=\s*(?:Shipment Number|PIECE OF CAKE|USDOT|\d{2}\/\d{2}\/\d{4}|Origin Loading Address))/i;
          let nameMatch = rawText.match(shipperNameRegex);
          if (nameMatch && nameMatch[1]) {
            clientName = nameMatch[1].replace(/[\n\r]+/g, " ").trim();
          } else if (jobNumber) {
            try {
              const nameBetweenRegex = new RegExp(
                `Shipment\\s*Number\\s*([A-Za-z][A-Za-z\\s'-]*[A-Za-z])\\s*${jobNumber}`,
                "i"
              );
              nameMatch = rawText.match(nameBetweenRegex);
              if (nameMatch && nameMatch[1]) clientName = nameMatch[1].trim();
            } catch (regexError) {
              console.error("Regex error for client name:", regexError);
            }
          }
          if (!clientName) {
            const customerSigRegex =
              /Customer Signature(?:[\s\S]*?Date[\s\S]*?){2}([A-Za-z\s'-]+?)(?:\n|\r|X\s|$)/i;
            nameMatch = rawText.match(customerSigRegex);
            if (nameMatch && nameMatch[1]) {
              let sigName = nameMatch[1]
                .replace(/packer pac/i, "")
                .replace(/Date/i, "")
                .trim();
              if (
                sigName.length > 1 &&
                sigName.toLowerCase() !== "x" &&
                sigName.split(/\s+/).length <= 3
              )
                clientName = sigName;
            }
          }

          const clientNameEl = document.getElementById("clientName");
          if (clientNameEl && !clientNameEl.value) {
            clientNameEl.value = clientName
              ? clientName
                  .split(/\s+/)
                  .map(
                    (p) => p.charAt(0).toUpperCase() + p.slice(1).toLowerCase()
                  )
                  .filter(Boolean)
                  .join(" ")
              : "";
            setFieldStatus(
              clientNameEl,
              clientName ? "pdf-informed" : "initial-default"
            );
          }
          const jobEl = document.getElementById("job");
          if (jobEl && !jobEl.value) {
            jobEl.value = jobNumber;
            setFieldStatus(
              jobEl,
              jobNumber ? "pdf-informed" : "initial-default"
            );
          }
          const lowerCaseText = rawText.toLowerCase();
          questions.forEach((q) => {
            const select = document.getElementById(q.id);
            if (select) {
              const keywords = keywordMap[q.id] || [];
              let itemFound =
                keywords.length > 0 &&
                keywords.some((kw) => lowerCaseText.includes(kw.toLowerCase()));
              let currentStatus = "pdf-informed";
              if (attentionFieldIds.includes(q.id)) { // This check might be less relevant now "wooden" is removed
                select.value = defaultValuesConfig[q.id];
              } else if (itemFound) {
                select.value = "YES";
              } else {
                select.value =
                  defaultValuesConfig[q.id] ||
                  q.options.find((opt) => opt.startsWith("NO ")) ||
                  q.options[1];
              }
              setFieldStatus(select, currentStatus);
              if (select.value === "NO") {
                select.dispatchEvent(new Event("change"));
              }
            }
          });
        } catch (err) {
          if (pdfStatus) pdfStatus.textContent = "Failed to read PDF.";
          console.error("Error reading PDF in handlePdfFileChange:", err);
          alert("Error reading PDF file. Check console for details.");
          if (viewPdfBtn) viewPdfBtn.style.display = "none";
        }
      }

      function updateSheetOutputString() {
        const warehouseEl = document.getElementById("sheetWarehouse");
        const addressEl = document.getElementById("sheetAddress");
        const palletsEl = document.getElementById("sheetPallets");
        const itemsEl = document.getElementById("sheetItems");
        const employeeNameEl = document.getElementById("sheetEmployeeName");
        const bingoStatusOkEl = document.getElementById("sheetBingoStatusOK");
        const bingoDetailsEl = document.getElementById("sheetBingoDetails");
        const matTvEl = document.getElementById("sheetMatTV");
        const matWrEl = document.getElementById("sheetMatWR");
        const matBlEl = document.getElementById("sheetMatBL");
        const warehouse = warehouseEl ? warehouseEl.value : "";
        const address = addressEl ? addressEl.value.trim() : "";
        const palletsVal = palletsEl ? palletsEl.value : "";
        const pallets =
          palletsVal && parseInt(palletsVal) > 0 ? `${palletsVal}pal` : "";
        const itemsVal = itemsEl ? itemsEl.value : "";
        const items = itemsVal ? `${itemsVal}itm` : "";
        const employeeName = employeeNameEl ? employeeNameEl.value.trim() : "";
        let bingoStatus;
        if (bingoStatusOkEl && bingoStatusOkEl.checked) {
          bingoStatus = "Bingo";
        } else {
          bingoStatus = bingoDetailsEl
            ? bingoDetailsEl.value.trim()
            : "issue_not_specified";
          if (bingoStatus === "") bingoStatus = "issue_not_specified";
        }
        const matTV = matTvEl ? matTvEl.value : "";
        const matWR = matWrEl ? matWrEl.value : "";
        const matBL = matBlEl ? matBlEl.value : "";
        let materialsArray = [];
        if (matTV && parseInt(matTV) > 0) materialsArray.push(`${matTV}tv`);
        if (matWR && parseInt(matWR) > 0) materialsArray.push(`${matWR}wr`);
        if (matBL && parseInt(matBL) > 0) materialsArray.push(`${matBL}bl`);
        const materialsString = materialsArray.join(",");
        const outputArray = [
          warehouse,
          address,
          pallets,
          items,
          employeeName,
          bingoStatus,
          materialsString,
        ];
        const sheetOutputEl = document.getElementById("sheetOutputString");
        if (sheetOutputEl)
          sheetOutputEl.value = outputArray
            .filter((s) => s && s.trim() !== "")
            .join(" | ");
      }

      function copySheetString() {
        const sheetOutputEl = document.getElementById("sheetOutputString");
        const textToCopy = sheetOutputEl ? sheetOutputEl.value : "";
        const statusDiv = document.getElementById("sheetDataStatus");
        if (!textToCopy) {
          if (statusDiv) {
            statusDiv.textContent = "Nothing to copy.";
            statusDiv.className = "error";
            setTimeout(() => {
              statusDiv.textContent = "";
              statusDiv.className = "";
            }, 2000);
          }
          return;
        }
        navigator.clipboard
          .writeText(textToCopy)
          .then(() => {
            if (statusDiv) {
              statusDiv.textContent = "Sheet string copied!";
              statusDiv.className = "success";
              setTimeout(() => {
                statusDiv.textContent = "";
                statusDiv.className = "";
              }, 2000);
            }
          })
          .catch((err) => {
            console.error("Sheet string copy failed:", err);
            if (statusDiv) {
              statusDiv.textContent = "Copy failed. Try manual.";
              statusDiv.className = "error";
              setTimeout(() => {
                statusDiv.textContent = "";
                statusDiv.className = "";
              }, 3000);
            }
          });
      }


      function saveSheetDataToLocalStorage() {
        const empNameEl = document.getElementById("sheetEmployeeName");
        const warehouseEl = document.getElementById("sheetWarehouse");
        if (empNameEl)
          localStorage.setItem("sheetEmployeeName", empNameEl.value);
        if (warehouseEl)
          localStorage.setItem("sheetWarehouse", warehouseEl.value);
      }

      function loadSheetDataFromLocalStorage() {
        const savedName = localStorage.getItem("sheetEmployeeName");
        const savedWarehouse = localStorage.getItem("sheetWarehouse");
        const empNameEl = document.getElementById("sheetEmployeeName");
        const warehouseEl = document.getElementById("sheetWarehouse");
        if (savedName && empNameEl) empNameEl.value = savedName;
        if (savedWarehouse && warehouseEl) warehouseEl.value = savedWarehouse;
      }

      function generatePhotoFilename(originalFile, isCameraCapture) {
        if (!isCameraCapture) return originalFile.name;

        cameraPhotoCounter++;
        const jobNum = document.getElementById("job")?.value.trim() || "NoJob";
        const clientNameRaw = document
          .getElementById("clientName")
          ?.value.trim();
        const clientName = clientNameRaw
          ? clientNameRaw.replace(/\s+/g, "_")
          : "NoClient";
        const dateStr = getCurrentDateFormatted();
        const extension = originalFile.name.includes(".")
          ? originalFile.name.substring(originalFile.name.lastIndexOf(".") + 1)
          : "jpg";

        return `${jobNum}_${clientName}_${dateStr}_${cameraPhotoCounter}.${extension}`;
      }

      function triggerPhotoDownload(fileOrBlob, filename) { // Accepts File or Blob
        const objectUrl = URL.createObjectURL(fileOrBlob);
        const anchor = document.createElement("a");
        anchor.href = objectUrl;
        anchor.download = filename;
        document.body.appendChild(anchor);
        anchor.click();
        document.body.removeChild(anchor);
        URL.revokeObjectURL(objectUrl);
      }

      async function compressAndDownloadImage(file, filename) {
        const MAX_SIZE_NO_COMPRESSION_KB = 500;
        const MAX_DIM_NO_COMPRESSION_PX = 1920;
        const TARGET_MAX_DIM_PX = 2000;
        const JPEG_QUALITY = 0.8;

        if (file.size / 1024 < MAX_SIZE_NO_COMPRESSION_KB) {
            console.log("File size under threshold, downloading original.");
            triggerPhotoDownload(file, filename);
            return;
        }

        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = async function() {
                const originalWidth = img.width;
                const originalHeight = img.height;

                if (Math.max(originalWidth, originalHeight) < MAX_DIM_NO_COMPRESSION_PX) {
                    console.log("Dimensions under threshold, downloading original.");
                    triggerPhotoDownload(file, filename);
                    return;
                }

                let targetWidth = originalWidth;
                let targetHeight = originalHeight;

                if (originalWidth > originalHeight) {
                    if (originalWidth > TARGET_MAX_DIM_PX) {
                        targetHeight = Math.round(originalHeight * (TARGET_MAX_DIM_PX / originalWidth));
                        targetWidth = TARGET_MAX_DIM_PX;
                    }
                } else {
                    if (originalHeight > TARGET_MAX_DIM_PX) {
                        targetWidth = Math.round(originalWidth * (TARGET_MAX_DIM_PX / originalHeight));
                        targetHeight = TARGET_MAX_DIM_PX;
                    }
                }
                
                // Ensure dimensions are not scaled up from original photo by mistake
                if (targetWidth > originalWidth) targetWidth = originalWidth;
                if (targetHeight > originalHeight) targetHeight = originalHeight;


                const canvas = document.createElement('canvas');
                canvas.width = targetWidth;
                canvas.height = targetHeight;
                const ctx = canvas.getContext('2d');
                ctx.drawImage(img, 0, 0, targetWidth, targetHeight);

                canvas.toBlob(function(blob) {
                    if (blob) {
                        if (blob.size > file.size) {
                            console.log("Compressed blob is larger than original, downloading original.");
                            triggerPhotoDownload(file, filename);
                        } else {
                            console.log("Downloading compressed image.");
                            triggerPhotoDownload(blob, filename);
                        }
                    } else {
                        console.error("Blob creation failed, downloading original.");
                        triggerPhotoDownload(file, filename);
                    }
                }, 'image/jpeg', JPEG_QUALITY);
            };
            img.onerror = function() {
                console.error("Image loading for compression failed, downloading original.");
                triggerPhotoDownload(file, filename);
            };
            img.src = event.target.result;
        };
        reader.onerror = function() {
            console.error("File reading for compression failed, downloading original.");
            triggerPhotoDownload(file, filename);
        };
        reader.readAsDataURL(file);
    }


      function processSelectedFiles(event, isCameraCapture) {
        const files = event.target.files;
        const previewsContainer = document.getElementById("photoPreviews");
        const commentsEnabled = document.getElementById(
          "enablePhotoCommentsToggle"
        ).checked;
        if (!previewsContainer) return;

        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          if (!file.type.startsWith("image/")) {
            continue;
          }

          const reader = new FileReader();
          reader.onload = function (e) {
            const photoId = `photo-${Date.now()}-${Math.random()
              .toString(36)
              .substr(2, 9)}`;
            const newPhoto = {
              id: photoId,
              file: file,
              originalDataUrl: e.target.result,
              compressedDataUrl: null,
              width: 0,
              height: 0,
              comment: "",
            };
            selectedPhotos.push(newPhoto);

            const previewItem = document.createElement("div");
            previewItem.className = "photo-preview-item";
            if (commentsEnabled) {
              previewItem.classList.add("comments-enabled");
            }
            previewItem.id = photoId;

            const img = document.createElement("img");
            img.src = e.target.result;
            img.onload = () => {
              newPhoto.width = img.naturalWidth;
              newPhoto.height = img.naturalHeight;
            };
            previewItem.appendChild(img);

            const commentTextarea = document.createElement("textarea");
            commentTextarea.className = "photo-comment-textarea";
            commentTextarea.placeholder = "Add a comment...";
            commentTextarea.oninput = (event) => {
              const photoToUpdate = selectedPhotos.find(
                (p) => p.id === photoId
              );
              if (photoToUpdate) {
                photoToUpdate.comment = event.target.value;
              }
            };
            previewItem.appendChild(commentTextarea);

            const deleteBtn = document.createElement("button");
            deleteBtn.className = "delete-photo-button";
            deleteBtn.title = "Delete photo";
            deleteBtn.type = "button";
            deleteBtn.onclick = function () {
              selectedPhotos = selectedPhotos.filter((p) => p.id !== photoId);
              const itemToRemove = document.getElementById(photoId);
              if (itemToRemove) itemToRemove.remove();
            };
            previewItem.appendChild(deleteBtn);
            previewsContainer.appendChild(previewItem);

            if (isCameraCapture) {
              const filename = generatePhotoFilename(file, true);
              compressAndDownloadImage(file, filename); // Use new compression function
            }
          };
          reader.readAsDataURL(file);
        }
        if (event.target) event.target.value = null;
      }

      function validateNoOptionComments() {
        let allNoCommentsValid = true;
        let missingCommentsMessages = [];
        questions.forEach((q) => {
          const selectElement = document.getElementById(q.id);
          const commentTextarea = document.getElementById(
            `no_comment_textarea_${q.id}`
          );
          if (commentTextarea)
            commentTextarea.style.borderColor = "var(--input-border)";
          if (selectElement && selectElement.value === "NO") {
            const itemName = selectElement.dataset.itemName;
            const templatePrefix = `${itemName} (NO): `;
            const currentComment = commentTextarea
              ? commentTextarea.value.trim()
              : "";
            if (
              currentComment === "" ||
              currentComment === templatePrefix.trim()
            ) {
              allNoCommentsValid = false;
              missingCommentsMessages.push(
                `Comment for "${q.itemName}" (NO) is required.`
              );
              if (commentTextarea)
                commentTextarea.style.borderColor = "var(--danger-red)";
            }
          }
        });
        return {
          isValid: allNoCommentsValid,
          messages: missingCommentsMessages,
        };
      }

      async function generatePdfWithPhotos() {
        const validationResult = validateNoOptionComments();
        const pdfGenerateStatus = document.getElementById("pdfGenerateStatus");

        if (!validationResult.isValid) {
          if (pdfGenerateStatus) {
            pdfGenerateStatus.textContent =
              "Validation failed. Please check comments.";
            pdfGenerateStatus.className = "error";
          }
          alert(
            "Please provide valid comments for all items marked 'NO':\n\n" +
              validationResult.messages.join("\n")
          );
          setTimeout(() => {
            if (pdfGenerateStatus) {
              pdfGenerateStatus.textContent = "";
              pdfGenerateStatus.className = "";
            }
          }, 5000);
          return;
        }

        if (
          typeof jspdf === "undefined" ||
          typeof jspdf.jsPDF === "undefined"
        ) {
          alert("Error: jsPDF library not loaded.");
          return;
        }
        const { jsPDF } = jspdf;
        const doc = new jsPDF({ orientation: "p", unit: "mm", format: "a4" });
        const loader = document.getElementById("pdfGenerateLoader");
        const statusEl = document.getElementById("pdfGenerateStatus");
        if (loader) loader.style.display = "block";
        if (statusEl) {
          statusEl.textContent = "Generating PDF...";
          statusEl.className = "";
        }
        await new Promise((resolve) => setTimeout(resolve, 100));

        try {
          let yPos = 15;
          const pageHeight = doc.internal.pageSize.height;
          const margin = 15;
          const contentWidth = doc.internal.pageSize.width - margin * 2;
          const lineHeight = 7;
          let hasNoAnswers = false;

          const rootStyles = getComputedStyle(document.documentElement);
          const orangeAccent =
            rootStyles.getPropertyValue("--knicks-orange-accent").trim() ||
            "#F58426";

          function addTextToPdf(text, x, currentY, options = {}) {
            if (currentY > pageHeight - margin - lineHeight) {
              doc.addPage();
              currentY = margin;
            }
            const originalColor = doc.getTextColor();
            const originalSize = doc.getFontSize();
            if (options.color) doc.setTextColor(options.color);
            if (options.size) doc.setFontSize(options.size);
            if (options.fontStyle) doc.setFont(undefined, options.fontStyle);

            doc.text(text, x, currentY, {
              maxWidth: options.maxWidth || contentWidth,
            });

            if (options.color) doc.setTextColor(originalColor);
            if (options.size) doc.setFontSize(originalSize);
            if (options.fontStyle) doc.setFont(undefined, "normal");
            return (
              currentY +
              lineHeight * ((options.size || originalSize) / originalSize)
            );
          }
          function addBoldTextToPdf(text, x, currentY, options = {}) {
            return addTextToPdf(text, x, currentY, {
              ...options,
              fontStyle: "bold",
            });
          }

          doc.setFontSize(16);
          yPos = addBoldTextToPdf(
            `Client: ${document.getElementById("clientName").value || "N/A"}`,
            margin,
            yPos
          );
          yPos = addBoldTextToPdf(
            `Job #: ${document.getElementById("job").value || "N/A"}`,
            margin,
            yPos
          );
          const cuFtInputVal = document.getElementById("cuFt").value.trim();
          if (cuFtInputVal) {
            yPos = addBoldTextToPdf(`CuFt: ${cuFtInputVal}`, margin, yPos);
          }
          yPos += lineHeight * 0.5;

          doc.setFontSize(10);
          yPos = addBoldTextToPdf("Report Details:", margin, yPos);
          questions.forEach((q) => {
            const selectVal = document.getElementById(q.id).value;
            let textOptions = {};
            if (selectVal === "NO") {
              textOptions.color = "red";
              hasNoAnswers = true;
            }
            yPos = addTextToPdf(`• ${q.text}`, margin, yPos, textOptions);
            const answerLines = doc.splitTextToSize(
              `  ${selectVal}`,
              contentWidth - 5
            );
            answerLines.forEach((line) => {
              yPos = addTextToPdf(line, margin + 5, yPos, textOptions);
            });
            if (selectVal === "NO") {
              const commentTextarea = document.getElementById(
                `no_comment_textarea_${q.id}`
              );
              if (
                commentTextarea &&
                commentTextarea.value.trim() !== `${q.itemName} (NO):` &&
                commentTextarea.value.trim() !== ""
              ) {
                const commentLines = doc.splitTextToSize(
                  `    Comment: ${commentTextarea.value.trim()}`,
                  contentWidth - 10
                );
                commentLines.forEach((line) => {
                  yPos = addTextToPdf(line, margin + 7, yPos, { color: "red" });
                });
              }
            }
          });

          const cuFtFromInput = document.getElementById("cuFt").value.trim();
          const palletsFromSheet = document
            .getElementById("sheetPallets")
            .value.trim();
          if (cuFtFromInput && palletsFromSheet) {
            const cuFtParsed = parseFloat(cuFtFromInput.replace(/,/g, ""));
            const palletsParsed = parseInt(palletsFromSheet, 10);

            if (
              !isNaN(cuFtParsed) &&
              !isNaN(palletsParsed) &&
              palletsParsed >= 0
            ) {
              yPos += lineHeight * 0.25;
              let cuFtPalletAttentionText = "";
              let cuFtPalletAttentionColor = "#000000";

              if (palletsParsed > 0) {
                const difference = palletsParsed * 100 - cuFtParsed;
                if (difference > 100) {
                  cuFtPalletAttentionText = `Pallet/CuFt Check: ATTENTION - Difference (${difference.toFixed(
                    1
                  )}) > 100. Formula: (Pallets * 100) - CuFt.`;
                  cuFtPalletAttentionColor = "#FF0000";
                } else if (difference < 0) {
                  cuFtPalletAttentionText = `Pallet/CuFt Check: OK - Difference (${difference.toFixed(
                    1
                  )}) is negative. Formula: (Pallets * 100) - CuFt.`;
                } else {
                  cuFtPalletAttentionText = `Pallet/CuFt Check: OK - Difference (${difference.toFixed(
                    1
                  )}) not over 100 & non-negative. Formula: (Pallets * 100) - CuFt.`;
                }
              }

              if (cuFtPalletAttentionText) {
                yPos = addTextToPdf(
                  `• ${cuFtPalletAttentionText}`,
                  margin,
                  yPos,
                  { color: cuFtPalletAttentionColor }
                );
              }
              yPos += lineHeight * 0.25;
            }
          }

          yPos += lineHeight * 0.5;
          yPos = addBoldTextToPdf("General Comments:", margin, yPos);
          const generalComments = document
            .getElementById("generalComments")
            .value.trim();
          if (generalComments) {
            const commentLines = doc.splitTextToSize(
              generalComments,
              contentWidth
            );
            commentLines.forEach((line) => {
              yPos = addTextToPdf("• " + line, margin, yPos);
            });
          } else {
            yPos = addTextToPdf("• None", margin, yPos);
          }
          yPos += lineHeight * 0.5;

          const ratingValue = parseFloat(
            document.getElementById("rating").value
          );
          let ratingTextOptions = {};
          if (ratingValue < 4) {
            ratingTextOptions.color = "#FF0000";
          }
          yPos = addBoldTextToPdf(
            `Rating: ${ratingValue.toFixed(1)}`,
            margin,
            yPos,
            ratingTextOptions
          );
          yPos += lineHeight * 0.5;

          yPos = addBoldTextToPdf("Google Sheets Data String:", margin, yPos);
          const sheetString =
            document.getElementById("sheetOutputString").value;
          const sheetStringLines = doc.splitTextToSize(
            sheetString,
            contentWidth
          );
          sheetStringLines.forEach((line) => {
            yPos = addTextToPdf(line, margin, yPos);
          });
          yPos += lineHeight;

          if (selectedPhotos.length > 0) {
            yPos = addBoldTextToPdf("Attached Photos:", margin, yPos);
            for (const photo of selectedPhotos) {
              if (yPos > pageHeight - margin - 50) {
                doc.addPage();
                yPos = margin;
              }
              try {
                const imgDataUrl = await compressImageForPdf( // Using a slightly different compression for PDF inclusion
                  photo.originalDataUrl,
                  1024, // Max width/height for PDF images
                  0.7   // Quality
                );
                photo.compressedDataUrl = imgDataUrl; // Store for potential re-use if needed
                const img = new Image();
                img.src = imgDataUrl;
                await new Promise((r) => (img.onload = r));
                let imgWidth = img.width,
                  imgHeight = img.height;
                const maxImgWidth = contentWidth;
                let maxImgHeight = pageHeight - yPos - margin - 5;
                if (photo.comment) maxImgHeight -= 11 * 0.352778 * 2; // Approx height for comment

                if (imgWidth > maxImgWidth) {
                  const r = maxImgWidth / imgWidth;
                  imgWidth = maxImgWidth;
                  imgHeight *= r;
                }
                if (imgHeight > maxImgHeight) {
                  const r = maxImgHeight / imgHeight;
                  imgHeight = maxImgHeight;
                  imgWidth *= r;
                }
                if (imgHeight <= 0 || imgWidth <= 0) {
                  console.warn("Skipping image due to zero dimension:", photo.file.name);
                  continue;
                }

                if (
                  yPos + imgHeight + (photo.comment ? 11 * 0.352778 * 2 : 0) >
                  pageHeight - margin
                ) {
                  doc.addPage();
                  yPos = margin;
                }
                const xCentered = (doc.internal.pageSize.width - imgWidth) / 2;
                doc.addImage(
                  imgDataUrl,
                  "JPEG", // Assuming compression to JPEG
                  xCentered,
                  yPos,
                  imgWidth,
                  imgHeight
                );
                yPos += imgHeight + 2;

                if (photo.comment && photo.comment.trim() !== "") {
                  if (yPos > pageHeight - margin - 11 * 0.352778 * 2) { // Check space for comment
                    doc.addPage();
                    yPos = margin;
                  }
                  doc.setFillColor(orangeAccent);
                  doc.rect(margin, yPos, 3, 3, "F"); // Small indicator for comment
                  const commentX = margin + 5;
                  const commentMaxWidth = contentWidth - 5;
                  doc.setFontSize(11);
                  const commentLines = doc.splitTextToSize(
                    photo.comment.trim(),
                    commentMaxWidth
                  );
                  commentLines.forEach((line) => {
                    if (yPos + 11 * 0.352778 > pageHeight - margin - 5) { // New page if comment overflows
                      doc.addPage();
                      yPos = margin;
                      doc.setFillColor(orangeAccent);
                      doc.rect(margin, yPos, 3, 3, "F");
                    }
                    doc.text(line, commentX, yPos + 2.5); // Adjust vertical alignment slightly
                    yPos += 11 * 0.352778; // Approximate line height in mm for 11pt
                  });
                  doc.setFontSize(10); // Reset font size
                  yPos += 2; // Extra space after comment
                }
                yPos += 3; // Space between photos
              } catch (imgError) {
                console.error("Error processing image for PDF:", photo.file.name, imgError);
                yPos = addTextToPdf(
                  `[Error embedding image: ${photo.file.name}]`,
                  margin,
                  yPos
                );
              }
            }
          }

          let fileName = `Report-${
            document.getElementById("job").value || "Custom"
          }`;
          if (hasNoAnswers) fileName += "_ATTENTION-NO";
          if (ratingValue < 4) fileName += "_RatingLow";
          fileName += ".pdf";
          const pdfOutput = doc.output("blob");
          let shared = false;

          if (
            navigator.share &&
            navigator.canShare &&
            navigator.canShare({
              files: [
                new File([pdfOutput], fileName, { type: "application/pdf" }),
              ],
            })
          ) {
            try {
              await navigator.share({
                files: [
                  new File([pdfOutput], fileName, { type: "application/pdf" }),
                ],
                title: fileName,
                text: `Report for Job #${
                  document.getElementById("job").value || "Custom"
                }`,
              });
              if (statusEl) {
                statusEl.textContent = "PDF shared! Also downloading.";
                statusEl.className = "success";
              }
              shared = true;
            } catch (shareError) {
              console.error("Share PDF error:", shareError);
              if (statusEl && !shared) {
                statusEl.textContent = "Share failed. Downloading.";
                statusEl.className = "error";
              }
            }
          }
          doc.save(fileName);
          if (statusEl && !shared) {
            statusEl.textContent = "PDF downloaded!";
            statusEl.className = "success";
          } else if (statusEl && shared) {
            /* Message already set */
          }
        } catch (error) {
          console.error("Generate PDF error:", error);
          if (statusEl) {
            statusEl.textContent = "Error PDF. See console.";
            statusEl.className = "error";
          }
          alert("Error PDF: " + error.message);
        } finally {
          if (loader) loader.style.display = "none";
          setTimeout(() => {
            if (statusEl) statusEl.textContent = "";
            statusEl.className = "";
          }, 5000);
        }
      }

      async function compressImageForPdf(dataUrl, maxWidthOrHeight, quality) { // Renamed for clarity
        return new Promise((resolve, reject) => {
          const img = new Image();
          img.onload = () => {
            let width = img.width;
            let height = img.height;
            if (width > height) {
                if (width > maxWidthOrHeight) {
                    height = Math.round(height * (maxWidthOrHeight / width));
                    width = maxWidthOrHeight;
                }
            } else {
                if (height > maxWidthOrHeight) {
                    width = Math.round(width * (maxWidthOrHeight / height));
                    height = maxWidthOrHeight;
                }
            }
            const canvas = document.createElement("canvas");
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext("2d");
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL("image/jpeg", quality)); // Force JPEG for PDF
          };
          img.onerror = reject;
          img.src = dataUrl;
        });
      }

      async function renderPdfPage(pdfDoc, pageNum, canvas) {
        const page = await pdfDoc.getPage(pageNum);
        const viewport = page.getViewport({ scale: 1.5 });
        canvas.height = viewport.height;
        canvas.width = viewport.width;
        const renderContext = {
          canvasContext: canvas.getContext("2d"),
          viewport: viewport,
        };
        await page.render(renderContext).promise;
      }
      async function displayPdfPageInModal(pageNum) {
        if (
          !loadedPdfDocument ||
          pageNum < 1 ||
          pageNum > loadedPdfDocument.numPages
        )
          return;
        currentPageInView = pageNum;
        const viewerContainer = document.getElementById("pdfViewerContainer");
        if (!viewerContainer) return;
        viewerContainer.innerHTML = "";
        const canvas = document.createElement("canvas");
        viewerContainer.appendChild(canvas);
        const currentPageNumEl = document.getElementById("currentPageNum");
        const totalPagesNumEl = document.getElementById("totalPagesNum");
        const prevPageBtn = document.getElementById("prevPage");
        const nextPageBtn = document.getElementById("nextPage");
        if (currentPageNumEl) currentPageNumEl.textContent = currentPageInView;
        if (totalPagesNumEl)
          totalPagesNumEl.textContent = loadedPdfDocument.numPages;
        if (prevPageBtn) prevPageBtn.disabled = currentPageInView <= 1;
        if (nextPageBtn)
          nextPageBtn.disabled =
            currentPageInView >= loadedPdfDocument.numPages;
        try {
          await renderPdfPage(loadedPdfDocument, currentPageInView, canvas);
        } catch (error) {
          console.error("Error rendering PDF page:", error);
          viewerContainer.textContent = "Error rendering PDF page.";
        }
      }
      function openPdfModal() {
        if (!loadedPdfDocument) {
          alert("Please upload a PDF file first.");
          return;
        }
        const modalEl = document.getElementById("pdfModal");
        if (modalEl) {
          modalEl.style.display = "flex";
          history.pushState({ pdfModalOpen: true }, "PDF Viewer", "#pdf");
        }
        displayPdfPageInModal(currentPageInView);
      }
      function closePdfModal(manageHistory = true) {
        const modalEl = document.getElementById("pdfModal");
        if (modalEl) modalEl.style.display = "none";
        const viewerEl = document.getElementById("pdfViewerContainer");
        if (viewerEl) viewerEl.innerHTML = "";
        if (manageHistory && window.location.hash === "#pdf") {
          history.back();
        }
      }
      function closePdfModalWithHistory() {
        closePdfModal(true);
      }

      function copyPalletData() {
        const jobNumber = document.getElementById("job").value;
        const clientName = document.getElementById("clientName").value;
        const currentDate = getCurrentDateFormatted("/");

        document.getElementById("palletJobNumber").textContent =
          jobNumber || "N/A";
        document.getElementById("palletClientName").textContent =
          clientName || "N/A";
        document.getElementById("palletCurrentDate").textContent = currentDate;

        const dataToCopy = `${jobNumber}\t${clientName}\t${currentDate}`;
        const statusDiv = document.getElementById("palletDataStatus");

        if (!jobNumber && !clientName) {
          if (statusDiv) {
            statusDiv.textContent = "No data in Job# or Client Name to copy.";
            statusDiv.className = "error";
            setTimeout(() => {
              statusDiv.textContent = "";
              statusDiv.className = "";
            }, 3000);
          }
          return;
        }

        navigator.clipboard
          .writeText(dataToCopy)
          .then(() => {
            if (statusDiv) {
              statusDiv.textContent = "Pallet paper data copied!";
              statusDiv.className = "success";
              setTimeout(() => {
                statusDiv.textContent = "";
                statusDiv.className = "";
              }, 2000);
            }
          })
          .catch((err) => {
            console.error("Pallet data copy failed:", err);
            if (statusDiv) {
              statusDiv.textContent = "Copy failed. Try manual.";
              statusDiv.className = "error";
              setTimeout(() => {
                statusDiv.textContent = "";
                statusDiv.className = "";
              }, 3000);
            }
          });
      }

      function clearReportData() {
        if (!confirm("Are you sure you want to clear all report data?")) {
          return;
        }

        allInputElementsForReset.forEach((element) => {
          if (element.tagName === "SELECT") {
            const questionConfig = questions.find((q) => q.id === element.id);
            if (questionConfig) {
              element.value =
                defaultValuesConfig[element.id] || questionConfig.options[0];
              if (element.value === "NO") {
                handleNoSelection({ target: element });
              } else {
                const commentContainer = document.getElementById(
                  `no_comment_container_${element.id}`
                );
                if (commentContainer) commentContainer.style.display = "none";
              }
            } else {
              element.selectedIndex = 0;
            }
          } else if (element.type === "checkbox") {
            element.checked = false;
          } else if (element.type === "file") {
            element.value = null;
          } else if (element.id === "rating") {
            element.value = "4.0";
          } else {
            element.value = "";
          }
          setFieldStatus(element, "initial-default");
        });

        const pdfFileInput = document.getElementById("pdfFile");
        if (pdfFileInput) pdfFileInput.value = null;
        const pdfStatus = document.getElementById("pdfStatus");
        if (pdfStatus) pdfStatus.textContent = "";
        loadedPdfDocument = null;
        const viewPdfBtn = document.getElementById("viewPdfBtn");
        if (viewPdfBtn) viewPdfBtn.style.display = "none";
        closePdfModal(false);

        selectedPhotos = [];
        cameraPhotoCounter = 0;
        const photoPreviewsContainer = document.getElementById("photoPreviews");
        if (photoPreviewsContainer) photoPreviewsContainer.innerHTML = "";
        document.getElementById("enablePhotoCommentsToggle").checked = false;
        togglePhotoCommentFields();

        const sheetFieldsToClearOrReset = {
          sheetAddress: "",
          sheetPallets: "",
          sheetItems: "",
          sheetBingoDetails: "",
          sheetMatTV: "",
          sheetMatWR: "",
          sheetMatBL: "",
        };
        for (const id in sheetFieldsToClearOrReset) {
          const el = document.getElementById(id);
          if (el) {
            el.value = sheetFieldsToClearOrReset[id];
            setFieldStatus(el, "initial-default");
          }
        }
        document.getElementById("sheetBingoStatusOK").checked = true;
        const bingoDetailsContainerEl = document.getElementById(
          "sheetBingoDetailsContainer"
        );
        if (bingoDetailsContainerEl)
          bingoDetailsContainerEl.style.display = "none";
        document.getElementById("useLoadingDock").checked = false;
        const sheetAddressInput = document.getElementById("sheetAddress");
        if (sheetAddressInput) {
          sheetAddressInput.disabled = false;
          setFieldStatus(sheetAddressInput, "initial-default");
        }

        const pdfItemCountEl = document.getElementById("pdfItemCount");
        if (pdfItemCountEl) pdfItemCountEl.textContent = "";
        const pdfMaterialCountsEl =
          document.getElementById("pdfMaterialCounts");
        if (pdfMaterialCountsEl) pdfMaterialCountsEl.textContent = "";

        loadSheetDataFromLocalStorage();
        const spreadsheetIdInput =
          document.getElementById("spreadsheetIdInput");
        if (spreadsheetIdInput) {
          const savedSpreadsheetId = localStorage.getItem("spreadsheetId");
          spreadsheetIdInput.value = savedSpreadsheetId || "";
        }
        const sheetNameInput = document.getElementById("sheetNameInput");
        if (sheetNameInput) {
          sheetNameInput.value = getCurrentDateFormatted("/");
        }
        const startRowInput = document.getElementById("startRowInput");
        if (startRowInput) startRowInput.value = "6";

        updateSheetOutputString();
        generateSheetFormula();

        const statusesToClear = [
          "pdfGenerateStatus",
          "sheetDataStatus",
          "palletDataStatus",
        ];
        statusesToClear.forEach((id) => {
          const el = document.getElementById(id);
          if (el) {
            el.textContent = "";
            el.className = "";
          }
        });

        alert("Report data has been cleared.");
      }
    </script>
  </body>
</html>