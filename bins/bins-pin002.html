<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Bin Tracker Pro</title>

    <style>
      :root {
        --bg-color: #f4f6f8;
        --main-color: #007bff;
        --secondary-color: #6c757d;
        --danger-color: #dc3545;
        --danger-bg: rgba(220, 53, 69, 0.07);
        --success-color: #28a745;
        --success-bg: rgba(40, 167, 69, 0.07);
        --warning-color: #ffc107;
        --wash-color: #17a2b8;
        --text-color: #212529;
        --light-text-color: #ffffff;
        --card-bg: #ffffff;
        --border-color: #dee2e6;
        --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
      }

      body,
      html {
        margin: 0;
        padding: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background-color: var(--bg-color);
        color: var(--text-color);
        font-size: 16px;
      }
      .app-container {
        max-width: 1000px;
        margin: 15px auto;
        padding: 15px;
      }
      .hidden {
        display: none !important;
      }
      .header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 25px;
        flex-wrap: wrap;
      }
      .header-title {
        font-size: 2.2rem;
        font-weight: bold;
        color: var(--main-color);
      }
      .header-controls {
        display: flex;
        align-items: center;
        gap: 15px;
      }
      #user-info {
        font-size: 1rem;
        font-weight: 500;
      }
      #logout-btn {
        padding: 8px 12px;
        font-size: 1rem;
        background-color: var(--danger-color);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
      }
      .lang-switcher button {
        background: none;
        border: 2px solid var(--border-color);
        border-radius: 10px;
        padding: 8px;
        margin-left: 8px;
        font-size: 1.8rem;
        cursor: pointer;
      }
      .lang-switcher button.active {
        border-color: var(--main-color);
      }
      .stock-display {
        display: flex;
        gap: 20px;
        margin-bottom: 30px;
      }
      .stock-card {
        flex: 1;
        background-color: var(--card-bg);
        padding: 20px;
        border-radius: 12px;
        text-align: center;
        box-shadow: var(--shadow);
      }
      .stock-card .title {
        font-size: 1.2rem;
        color: var(--secondary-color);
        margin-bottom: 8px;
      }
      .stock-card .count {
        font-size: 3.5rem;
        font-weight: bold;
      }
      .stock-card .count.clean {
        color: var(--success-color);
      }
      .stock-card .count.dirty {
        color: var(--danger-color);
      }
      .actions-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin-bottom: 30px;
      }
      .action-button {
        font-size: 1.2rem;
        font-weight: 500;
        padding: 20px;
        border: none;
        border-radius: 12px;
        color: var(--light-text-color);
        cursor: pointer;
        transition: filter 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        line-height: 1.2;
      }
      .action-button:hover {
        filter: brightness(1.1);
      }
      #add-entry-btn {
        background-color: var(--main-color);
      }
      #wash-bins-btn {
        background-color: var(--wash-color);
      }
      #adjust-stock-btn {
        background-color: var(--warning-color);
        color: var(--text-color);
      }
      .report-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
        padding: 20px;
        background: var(--card-bg);
        border-radius: 12px;
        box-shadow: var(--shadow);
        margin-bottom: 30px;
      }
      .report-section .date-picker-group {
        display: flex;
        align-items: center;
        gap: 10px;
      }
      .report-section label {
        font-weight: 500;
      }
      .report-section input[type="date"] {
        padding: 8px;
        border-radius: 8px;
        border: 2px solid var(--border-color);
        font-size: 1rem;
      }
      .report-section .action-button {
        padding: 12px;
      }
      #report-btn {
        background-color: var(--secondary-color);
      }
      .transactions-list h3 {
        font-size: 1.5rem;
        border-bottom: 2px solid var(--border-color);
        padding-bottom: 8px;
      }
      #transactions-container {
        margin-top: 15px;
        font-size: 1.1rem;
      }
      .transaction-item {
        background-color: var(--card-bg);
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        display: flex;
        align-items: center;
        gap: 15px;
      }
      .transaction-item .icon {
        font-size: 1.5rem;
      }
      .transaction-item .details {
        flex-grow: 1;
      }
      .transaction-item .time {
        font-size: 0.9em;
        color: var(--secondary-color);
      }
      .transaction-comment {
        font-style: italic;
        font-size: 0.95em;
        color: #555;
      }
      .transaction-actions {
        margin-left: auto;
        display: flex;
        gap: 5px;
      }
      .transaction-actions button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        padding: 5px;
        border-radius: 50%;
      }
      .transaction-actions button:hover {
        background-color: #f0f0f0;
      }
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.6);
        justify-content: center;
        align-items: center;
      }
      .modal-content {
        background-color: var(--bg-color);
        padding: 30px;
        border-radius: 15px;
        width: 90%;
        max-width: 600px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      }
      .modal-content h2 {
        font-size: 1.8rem;
        margin-top: 0;
        margin-bottom: 25px;
      }
      .form-group {
        margin-bottom: 20px;
      }
      .form-group label {
        display: block;
        font-size: 1.1rem;
        margin-bottom: 8px;
        font-weight: 500;
      }
      .form-group input {
        width: 100%;
        padding: 12px;
        font-size: 1.1rem;
        border-radius: 8px;
        border: 2px solid var(--border-color);
        box-sizing: border-box;
      }
      .form-group input.invalid {
        border-color: var(--danger-color);
        box-shadow: 0 0 5px rgba(220, 53, 69, 0.4);
      }
      .validation-message {
        color: var(--danger-color);
        font-size: 0.9em;
        text-align: left;
        margin-top: 5px;
        display: none;
      }
      .truck-ops-container {
        display: flex;
        gap: 15px;
        margin-bottom: 20px;
      }
      .truck-op-section {
        flex: 1;
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }
      .truck-op-section.inbound {
        background-color: var(--danger-bg);
      }
      .truck-op-section.outbound {
        background-color: var(--success-bg);
      }
      .truck-op-section h3 {
        font-size: 1.2rem;
        margin-top: 0;
        margin-bottom: 15px;
      }
      .bin-counter {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 15px;
      }
      .bin-quick-btn-group {
        display: flex;
        gap: 10px;
      }
      .bin-quick-btn {
        font-size: 1rem;
        font-weight: bold;
        padding: 8px 16px;
        border-radius: 20px;
        border: none;
        color: var(--light-text-color);
        cursor: pointer;
        background-color: var(--secondary-color);
      }
      .bin-count-display {
        font-size: 3.5rem;
        font-weight: bold;
        min-width: 80px;
        text-align: center;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s;
      }
      .bin-count-display:hover {
        background-color: #e0e0e0;
      }
      .bin-count-input {
        font-size: 3.5rem;
        font-weight: bold;
        width: 140px;
        text-align: center;
        border: 2px solid var(--main-color);
      }
      #report-text-area {
        width: 100%;
        height: 400px;
        font-family: monospace;
        font-size: 0.9rem;
      }
      .modal-actions {
        display: flex;
        gap: 15px;
        margin-top: 25px;
      }
       .modal-actions .action-button {
          flex: 1;
          padding: 15px;
          font-size: 1.1rem;
          color: white;
          border: none;
          border-radius: 8px;
       }
      .backup-section {
        margin-top: 30px;
        padding: 20px;
        background: #e9ecef;
        border-radius: 12px;
      }
      .backup-section h3 {
        margin-top: 0;
      }
      .backup-section .action-button {
        background-color: #5a6268;
      }

      /* User Management and Login Styles */
      #login-modal .modal-content {
          max-width: 400px;
      }
      #pin-display {
          height: 60px;
          width: 100%;
          background-color: var(--card-bg);
          border: 2px solid var(--border-color);
          border-radius: 12px;
          font-size: 2.5rem;
          letter-spacing: 0.5em;
          text-align: center;
          line-height: 60px;
          margin-bottom: 20px;
          font-family: monospace;
      }
      #pin-display.error {
          border-color: var(--danger-color);
          animation: shake 0.5s;
      }
      @keyframes shake {
        0%, 100% { transform: translateX(0); }
        25% { transform: translateX(-5px); }
        75% { transform: translateX(5px); }
      }
      .pin-pad {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 15px;
      }
      .pin-key {
          padding: 20px;
          font-size: 1.8rem;
          font-weight: bold;
          border: none;
          border-radius: 12px;
          background-color: var(--card-bg);
          box-shadow: var(--shadow);
          cursor: pointer;
      }
      .pin-key:hover {
          background-color: #e9ecef;
      }
      #admin-panel-btn {
        margin-top: 15px;
        background: none;
        border: none;
        color: var(--main-color);
        text-decoration: underline;
        cursor: pointer;
      }
      #user-list {
        list-style: none;
        padding: 0;
        margin-bottom: 20px;
        max-height: 200px;
        overflow-y: auto;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        padding: 10px;
      }
      .user-list-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px;
        background-color: var(--card-bg);
        border-radius: 6px;
        margin-bottom: 5px;
      }
      .delete-user-btn {
        background-color: var(--danger-color);
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
      }

      @media (max-width: 600px) {
        .truck-ops-container {
          flex-direction: column;
        }
        .header-title {
          width: 100%;
          text-align: center;
          margin-bottom: 10px;
        }
        .header-controls {
            width: 100%;
            justify-content: center;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container hidden">
      <header class="header">
        <h1 class="header-title" data-key="appTitle">Bin Tracker</h1>
        <div class="header-controls">
            <div id="user-info" class="hidden">
                <span id="current-user-greeting"></span> <span id="current-user-name"></span>
                <button id="logout-btn" data-key="logout">Logout</button>
            </div>
            <div class="lang-switcher">
                <button id="lang-en">üá¨üáß</button> <button id="lang-sr">üá∑üá∏</button>
            </div>
        </div>
      </header>

      <main>
        <section class="stock-display">
          <div class="stock-card">
            <div class="title" data-key="cleanStock">Clean Bins</div>
            <div id="clean-stock-count" class="count clean">0</div>
          </div>
          <div class="stock-card">
            <div class="title" data-key="dirtyStock">Dirty Bins</div>
            <div id="dirty-stock-count" class="count dirty">0</div>
          </div>
        </section>

        <section class="actions-grid">
          <button id="add-entry-btn" class="action-button">
            <span data-key="addEntry">üöö Add Truck Entry</span>
          </button>
          <button id="wash-bins-btn" class="action-button">
            <span data-key="washBins">üíß Wash Bins</span>
          </button>
          <button id="adjust-stock-btn" class="action-button">
            <span data-key="adjustStock">‚öôÔ∏è Adjust Stock</span>
          </button>
        </section>

        <section class="report-section">
          <label for="report-date" data-key="reportForDate">Report for date:</label>
          <div class="date-picker-group">
            <input type="date" id="report-date" />
            <button id="report-btn" class="action-button">
              <span data-key="generateReport">üìä Generate</span>
            </button>
          </div>
        </section>

        <section class="transactions-list">
          <h3 data-key="todaysTransactions">Today's Transactions</h3>
          <div id="transactions-container"></div>
        </section>

        <section class="backup-section">
          <h3 data-key="backupTitle">Backup & Restore</h3>
          <div class="actions-grid">
            <button id="backup-btn" class="action-button">
              <span data-key="backupBtn">Download Backup</span>
            </button>
            <button id="restore-btn" class="action-button">
              <span data-key="restoreBtn">Restore from File</span>
            </button>
            <input type="file" id="restore-file-input" style="display: none" accept=".json"/>
          </div>
        </section>
      </main>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <h2 data-key="pinLogin">PIN Login</h2>
            <div id="pin-display"></div>
            <div class="pin-pad">
                <button class="pin-key" data-key="1">1</button>
                <button class="pin-key" data-key="2">2</button>
                <button class="pin-key" data-key="3">3</button>
                <button class="pin-key" data-key="4">4</button>
                <button class="pin-key" data-key="5">5</button>
                <button class="pin-key" data-key="6">6</button>
                <button class="pin-key" data-key="7">7</button>
                <button class="pin-key" data-key="8">8</button>
                <button class="pin-key" data-key="9">9</button>
                <button class="pin-key" data-key="clear" data-key-ui="clearPin">C</button>
                <button class="pin-key" data-key="0">0</button>
                <button class="pin-key" data-key="login" data-key-ui="login">‚úîÔ∏è</button>
            </div>
            <button id="admin-panel-btn" data-key="adminPanel">Administration</button>
        </div>
    </div>
    
    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <h2 data-key="userManagement">User Management</h2>
            <h3>Existing Users</h3>
            <ul id="user-list"></ul>
            <h3>Add New User</h3>
            <div class="form-group">
                <label for="new-user-name" data-key="userName">User Name</label>
                <input type="text" id="new-user-name" required />
            </div>
            <div class="form-group">
                <label for="new-user-pin" data-key="userPin">PIN (4 digits)</label>
                <input type="text" id="new-user-pin" required pattern="\d{4}" maxlength="4" />
            </div>
            <div class="modal-actions">
                <button class="cancel-btn action-button" style="background-color: var(--secondary-color);"><span data-key="close">Close</span></button>
                <button id="add-user-btn" class="action-button" style="background-color: var(--success-color);"><span data-key="addUser">Add User</span></button>
            </div>
        </div>
    </div>

    <div id="entry-modal" class="modal">
      <div class="modal-content" data-editing-id="">
        <h2 data-key="newEntryTitle">New Truck Entry</h2>
        <div class="form-group" style="flex: 1">
            <label for="job-number" data-key="jobNumber">Job Number</label>
            <input type="text" id="job-number" required />
            <div class="validation-message" data-key="fieldRequired">This field is required.</div>
        </div>
        <div class="form-group">
          <label for="truck-number" data-key="truckNumber">Truck Number</label>
          <input type="text" id="truck-number" required />
          <div class="validation-message" data-key="fieldRequired">This field is required.</div>
        </div>
        <div class="truck-ops-container">
          <div class="truck-op-section inbound">
            <h3 data-key="inboundDirty">üì• Dirty In</h3>
            <div class="bin-counter" data-type="dirtyIn">
              <span class="bin-count-display">0</span>
              <div class="bin-quick-btn-group">
                <button class="bin-quick-btn" data-op="add" data-value="25">+25</button>
                <button class="bin-quick-btn" data-op="add" data-value="100">+100</button>
              </div>
            </div>
          </div>
          <div class="truck-op-section outbound">
            <h3 data-key="outboundClean">üì§ Clean Out</h3>
            <div class="bin-counter" data-type="cleanOut">
              <span class="bin-count-display">0</span>
              <div class="bin-quick-btn-group">
                <button class="bin-quick-btn" data-op="add" data-value="25">+25</button>
                <button class="bin-quick-btn" data-op="add" data-value="100">+100</button>
              </div>
            </div>
          </div>
        </div>
        <div class="validation-message" id="entry-form-validation"></div>
        <div class="modal-actions">
          <button class="cancel-btn action-button" style="background-color: var(--secondary-color);"><span data-key="cancel">Cancel</span></button>
          <button id="save-entry-btn" class="action-button" style="background-color: var(--success-color);"><span data-key="save">Save</span></button>
        </div>
      </div>
    </div>

    <div id="wash-modal" class="modal">
      <div class="modal-content" data-editing-id="">
        <h2 data-key="washBinsTitle">Wash Bins</h2>
        <div class="form-group">
          <label data-key="quantityWashed">Quantity Washed</label>
          <div class="bin-counter" data-type="washQty">
            <span class="bin-count-display">0</span>
            <div class="bin-quick-btn-group">
              <button class="bin-quick-btn" data-op="add" data-value="25">+25</button>
              <button class="bin-quick-btn" data-op="add" data-value="100">+100</button>
            </div>
          </div>
        </div>
        <div class="form-group">
          <label for="wash-comment" data-key="comment">Comment</label>
          <input type="text" id="wash-comment" />
        </div>
        <div class="validation-message" id="wash-form-validation"></div>
        <div class="modal-actions">
          <button class="cancel-btn action-button" style="background-color: var(--secondary-color);"><span data-key="cancel">Cancel</span></button>
          <button id="save-wash-btn" class="action-button" style="background-color: var(--success-color);"><span data-key="save">Save</span></button>
        </div>
      </div>
    </div>

    <div id="adjust-modal" class="modal">
      <div class="modal-content" data-editing-id="">
        <h2 data-key="adjustStockTitle">Adjust Stock</h2>
        <div class="form-group">
          <label for="adjust-clean" data-key="newCleanStock">New Clean Bins Total</label>
          <input type="number" id="adjust-clean" required />
        </div>
        <div class="form-group">
          <label for="adjust-dirty" data-key="newDirtyStock">New Dirty Bins Total</label>
          <input type="number" id="adjust-dirty" required />
        </div>
        <div class="form-group">
          <label for="adjust-reason" data-key="reasonForAdjustment">Reason for Adjustment</label>
          <input type="text" id="adjust-reason" required />
        </div>
        <div class="validation-message" id="adjust-form-validation"></div>
        <div class="modal-actions">
          <button class="cancel-btn action-button" style="background-color: var(--secondary-color);"><span data-key="cancel">Cancel</span></button>
          <button id="save-adjust-btn" class="action-button" style="background-color: var(--success-color);"><span data-key="save">Save</span></button>
        </div>
      </div>
    </div>

    <div id="report-modal" class="modal">
      <div class="modal-content">
        <h2 data-key="reportTitle">Daily Report</h2>
        <div id="report-html-container" style="width: 100%; max-width: 100%; height: 400px; overflow: auto; border: 1px solid #ccc; background-color: #fff;"></div>
        <div class="modal-actions">
          <button class="cancel-btn action-button" style="background-color: var(--secondary-color);"><span data-key="close">Close</span></button>
          <button id="copy-report-btn" class="action-button" style="background-color: var(--main-color);"><span data-key="copyData">Copy Report</span></button>
        </div>
      </div>
    </div>

    <div id="setup-modal" class="modal">
      <div class="modal-content">
        <h2 data-key="initialSetup">Initial Setup</h2>
        <p data-key="initialSetupText" style="font-size: 1.1rem; margin-bottom: 20px;">Please enter the current number of bins in stock to get started.</p>
        <div class="form-group">
          <label for="initial-clean" data-key="initialClean">Initial Clean Bins</label>
          <input type="number" id="initial-clean" placeholder="e.g., 1000" />
        </div>
        <div class="form-group">
          <label for="initial-dirty" data-key="initialDirty">Initial Dirty Bins</label>
          <input type="number" id="initial-dirty" placeholder="e.g., 50" />
        </div>
        <div class="modal-actions">
          <button id="save-setup-btn" class="action-button" style="width: 100%; background-color: var(--success-color);"><span data-key="saveInitialStock">Save Initial Stock</span></button>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        const translations = {
          en: {
            appTitle: "Bin Tracker", cleanStock: "Clean Bins", dirtyStock: "Dirty Bins", addEntry: "üöö Add Truck Entry", washBins: "üíß Wash Bins", adjustStock: "‚öôÔ∏è Adjust Stock", generateReport: "Generate", todaysTransactions: "Today's Transactions", newEntryTitle: "New Truck Entry", truckNumber: "Truck Number", inboundDirty: "üì• Dirty In", outboundClean: "üì§ Clean Out", jobNumber: "Job Number", washBinsTitle: "Wash Bins", quantityWashed: "Quantity Washed", employeeName: "Employee Name", comment: "Comment", adjustStockTitle: "Adjust Stock", newCleanStock: "New Clean Bins Total", newDirtyStock: "New Dirty Bins Total", reasonForAdjustment: "Reason for Adjustment", cancel: "Cancel", save: "Save", close: "Close", reportTitle: "Daily Report", copyData: "Copy Report", copied: "Copied!", initialSetup: "Initial Setup", initialSetupText: "Please enter the current number of bins in stock to get started.", initialClean: "Initial Clean Bins", initialDirty: "Initial Dirty Bins", saveInitialStock: "Save Initial Stock", truck: "Truck", received: "Received", shipped: "Shipped", washed: "Washed", adjustment: "Adjustment", clean: "Clean", dirty: "Dirty", reportForDate: "Report for date:", backupTitle: "Backup & Restore", backupBtn: "Download Backup", restoreBtn: "Restore from File", fieldRequired: "This field is required.", noDataForDate: "No data found for the selected date.", activityByUser: "Activity by Employee", summaryTitle: "Summary", binMovement: "Bin Movement", totalReceived: "Total Received", totalShipped: "Total Shipped", washingSummary: "Washing Summary", pinLogin: "PIN Login", adminPanel: "Administration", userManagement: "User Management", userName: "User Name", userPin: "PIN (4 digits)", addUser: "Add User", logout: "Logout",
            currentUserGreeting: "User:", clearPin: "C", login: "‚úîÔ∏è",
          },
          sr: {
            appTitle: "Praƒáenje Kanti", cleanStock: "ƒåiste Kante", dirtyStock: "Prljave Kante", addEntry: "üöö Dodaj Unos Kamiona", washBins: "üíß Operi Kante", adjustStock: "‚öôÔ∏è Podesi Stanje", generateReport: "Generi≈°i", todaysTransactions: "Dana≈°nje Transakcije", newEntryTitle: "Novi Unos Kamiona", truckNumber: "Broj Kamiona", inboundDirty: "üì• Prijem Prljavih", outboundClean: "üì§ Otprema ƒåistih", jobNumber: "Broj Posla", washBinsTitle: "Pranje Kanti", quantityWashed: "Oprana Koliƒçina", employeeName: "Ime Zaposlenog", comment: "Komentar", adjustStockTitle: "Pode≈°avanje Stanja", newCleanStock: "Novo Ukupno ƒåistih", newDirtyStock: "Novo Ukupno Prljavih", reasonForAdjustment: "Razlog Pode≈°avanja", cancel: "Otka≈æi", save: "Saƒçuvaj", close: "Zatvori", reportTitle: "Dnevni Izve≈°taj", copyData: "Kopiraj Izve≈°taj", copied: "Kopirano!", initialSetup: "Poƒçetno Pode≈°avanje", initialSetupText: "Molimo unesite trenutni broj kanti na zalihama.", initialClean: "Poƒçetni broj ƒçistih kanti", initialDirty: "Poƒçetni broj prljavih kanti", saveInitialStock: "Saƒçuvaj Poƒçetno Stanje", truck: "Kamion", received: "Primljeno", shipped: "Poslato", washed: "Oprano", adjustment: "Pode≈°avanje", clean: "ƒåiste", dirty: "Prljave", reportForDate: "Izve≈°taj za datum:", backupTitle: "Bekap i Oporavak", backupBtn: "Preuzmi Bekap", restoreBtn: "Oporavi iz Fajla", fieldRequired: "Ovo polje je obavezno.", noDataForDate: "Nema podataka za izabrani datum.", activityByUser: "Aktivnost po Zaposlenom", summaryTitle: "Rezime", binMovement: "Kretanje Kanti", totalReceived: "Ukupno Primljeno", totalShipped: "Ukupno Poslato", washingSummary: "Rezime Pranja", pinLogin: "PIN Prijava", adminPanel: "Administracija", userManagement: "Upravljanje Korisnicima", userName: "Ime Korisnika", userPin: "PIN (4 cifre)", addUser: "Dodaj Korisnika", logout: "Odjavi se",
            currentUserGreeting: "Korisnik:", clearPin: "C", login: "‚úîÔ∏è",
          },
        };

        // --- STATE MANAGEMENT ---
        let state = {
          stock: { clean: 0, dirty: 0 },
          transactions: [],
          users: [], // New: users array
          language: "en",
        };

        const ui = {
            appContainer: document.querySelector(".app-container"),
            loginModal: document.getElementById("login-modal"),
            adminModal: document.getElementById("admin-modal"),
            pinDisplay: document.getElementById("pin-display"),
            transactionsContainer: document.getElementById("transactions-container"),
            reportDateInput: document.getElementById("report-date"),
            userInfo: document.getElementById("user-info"),
            currentUserName: document.getElementById("current-user-name"),
            userList: document.getElementById("user-list"),
        };
        
        let inactivityTimer;

        // --- CORE FUNCTIONS ---
        const saveState = () => localStorage.setItem("binTrackerState", JSON.stringify(state));
        
        const loadState = () => {
            const savedState = localStorage.getItem("binTrackerState");
            if (savedState) {
                state = JSON.parse(savedState);
                // Ensure users array exists
                if (!state.users) {
                    state.users = [];
                }
            }
            // Create admin user if no users exist
            if (state.users.length === 0) {
                state.users.push({ id: Date.now(), name: 'admin', pin: '0000' });
                saveState();
            }
        };

        const updateStockDisplay = () => {
          document.getElementById("clean-stock-count").textContent = state.stock.clean;
          document.getElementById("dirty-stock-count").textContent = state.stock.dirty;
        };

        const T = (key) => translations[state.language][key] || key;

        // --- AUTHENTICATION & SESSION ---
        function handleLogout() {
            sessionStorage.removeItem('currentUser');
            location.reload();
        }

        function resetInactivityTimer() {
            clearTimeout(inactivityTimer);
            // Logout after 1 minute (60000 ms) of inactivity
            inactivityTimer = setTimeout(handleLogout, 60000);
        }

        function setupInactivityListeners() {
            resetInactivityTimer();
            ['mousemove', 'mousedown', 'keypress', 'scroll', 'touchstart'].forEach(event => 
                window.addEventListener(event, resetInactivityTimer)
            );
            // Logout when tab is hidden/app is in background
            document.addEventListener("visibilitychange", () => {
                if (document.visibilityState === 'hidden') {
                    clearTimeout(inactivityTimer); // Clear timer to prevent double logout
                    handleLogout();
                }
            });
        }
        
        function getCurrentUser() {
            const userJson = sessionStorage.getItem('currentUser');
            if (!userJson) {
                handleLogout();
                return null;
            }
            return JSON.parse(userJson);
        }

        function renderTransactions() {
          ui.transactionsContainer.innerHTML = "";
          const today = new Date().toLocaleDateString();
          state.transactions
            .filter((t) => new Date(t.timestamp).toLocaleDateString() === today)
            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)) // Sort descending
            .forEach((t) => {
              const div = document.createElement("div");
              div.className = "transaction-item";
              const time = new Date(t.timestamp).toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
              let content = "";

              switch (t.type) {
                case "truck":
                  content = `<div class="icon">üöö</div><div class="details"><b>${T("truck")} ${t.truckNumber}</b> (Job: ${t.jobNumber || "N/A"}) by <b>${t.user}</b><br>
                        ${ t.dirtyIn > 0 ? `<span style="color:var(--danger-color)">+${t.dirtyIn} ${T("received")}</span>` : ""}
                        ${t.dirtyIn > 0 && t.cleanOut > 0 ? " / " : ""}
                        ${ t.cleanOut > 0 ? `<span style="color:var(--success-color)">-${t.cleanOut} ${T("shipped")}</span>`: "" }
                        <div class="time">${time}</div></div>`;
                  break;
                case "wash":
                  content = `<div class="icon">üíß</div><div class="details"><b>+${t.quantity} ${T("washed")}</b> by <b>${t.user}</b><br>
                        ${ t.comment ? `<span class="transaction-comment">${t.comment}</span><br>` : "" }
                        <div class="time">${time}</div></div>`;
                  break;
                case "adjust":
                  const cleanChange = `${T("clean")}: ${t.oldClean} ‚Üí <b>${t.newClean}</b>`;
                  const dirtyChange = `${T("dirty")}: ${t.oldDirty} ‚Üí <b>${t.newDirty}</b>`;
                  content = `<div class="icon">‚öôÔ∏è</div><div class="details"><b>${T("adjustment")}</b> by <b>${t.user}</b> (${cleanChange} / ${dirtyChange})<br>
                        <span class="transaction-comment">${t.reason}</span><br>
                        <div class="time">${time}</div></div>`;
                  break;
              }

              content += `<div class="transaction-actions"><button class="edit-btn" data-id="${t.id}">‚úèÔ∏è</button><button class="delete-btn" data-id="${t.id}">üóëÔ∏è</button></div>`;
              div.innerHTML = content;
              ui.transactionsContainer.appendChild(div);
            });
        }

        function setLanguage(lang) {
          state.language = lang;
          document.querySelectorAll("[data-key]").forEach((elem) => {
            const key = elem.dataset.key;
            if (translations[lang][key]) elem.textContent = translations[lang][key];
          });
          document.querySelectorAll("[data-key-ui]").forEach((elem) => {
            const key = elem.dataset.keyUi;
            if (translations[lang][key]) elem.textContent = translations[lang][key];
          });
          Object.values(document.querySelectorAll(".lang-switcher button")).forEach((btn) => btn.classList.remove("active"));
          document.getElementById(`lang-${lang}`).classList.add("active");
          
          const currentUser = sessionStorage.getItem('currentUser');
          if (currentUser) {
            document.getElementById('current-user-greeting').textContent = T('currentUserGreeting');
            document.getElementById('logout-btn').textContent = T('logout');
          }
          renderTransactions();
          saveState();
        }

        const openModal = (modal) => (modal.style.display = "flex");
        const closeModal = (modal) => {
          modal.style.display = "none";
          const form = modal.querySelector(".modal-content");
          if (form) clearValidation(form);
        };

        function validateForm(formElement) {
          let isValid = true;
          clearValidation(formElement);
          formElement.querySelectorAll("input[required]").forEach((input) => {
            if (!input.value.trim()) {
              input.classList.add("invalid");
              const validationMessage = formElement.querySelector(`#${input.id}-validation`) || input.parentElement.querySelector(".validation-message");
              if (validationMessage) validationMessage.style.display = "block";
              isValid = false;
            }
          });
          return isValid;
        }

        function clearValidation(formElement) {
          formElement.querySelectorAll("input.invalid").forEach((input) => {
            input.classList.remove("invalid");
            const validationMessage = formElement.querySelector(`#${input.id}-validation`) || input.parentElement.querySelector(".validation-message");
            if (validationMessage) validationMessage.style.display = "none";
          });
        }

        // --- MODAL & FORM LOGIC ---
        document.querySelectorAll(".cancel-btn").forEach((btn) => btn.addEventListener("click", (e) => closeModal(e.target.closest(".modal"))));

        document.querySelectorAll(".bin-counter").forEach((counter) => {
          const span = counter.querySelector(".bin-count-display");
          counter.addEventListener("click", (e) => {
            if (e.target.tagName !== "BUTTON") return;
            let count = parseInt(span.textContent, 10);
            if (e.target.dataset.op === "add") count += parseInt(e.target.dataset.value, 10);
            span.textContent = count;
          });
          span.addEventListener("click", () => {
            const input = document.createElement("input");
            input.type = "number";
            input.className = "bin-count-input";
            input.value = span.textContent;
            span.replaceWith(input);
            input.focus();
            const onBlur = () => {
              span.textContent = Math.max(0, parseInt(input.value, 10) || 0);
              input.replaceWith(span);
            };
            input.addEventListener("blur", onBlur);
            input.addEventListener("keydown", (e) => {
              if (e.key === "Enter") e.target.blur();
            });
          });
        });

        document.getElementById("add-entry-btn").addEventListener("click", () => {
            const modal = document.getElementById("entry-modal");
            modal.querySelector("h2").textContent = T("newEntryTitle");
            modal.dataset.editingId = "";
            modal.querySelectorAll("input").forEach((i) => (i.value = ""));
            modal.querySelectorAll(".bin-count-display").forEach((s) => (s.textContent = "0"));
            openModal(modal);
        });
        document.getElementById("wash-bins-btn").addEventListener("click", () => {
            const modal = document.getElementById("wash-modal");
            modal.dataset.editingId = "";
            modal.querySelectorAll("input").forEach((i) => (i.value = ""));
            modal.querySelector(".bin-count-display").textContent = "0";
            openModal(modal);
        });
        document.getElementById("adjust-stock-btn").addEventListener("click", () => {
            const modal = document.getElementById("adjust-modal");
            modal.dataset.editingId = "";
            document.getElementById("adjust-clean").value = state.stock.clean;
            document.getElementById("adjust-dirty").value = state.stock.dirty;
            document.getElementById("adjust-reason").value = "";
            openModal(modal);
        });

        document.getElementById("save-entry-btn").addEventListener("click", () => {
            const modal = document.getElementById("entry-modal");
            if (!validateForm(modal)) return;
            
            const currentUser = getCurrentUser();
            if (!currentUser) return;

            const truckNumber = document.getElementById("truck-number").value.trim();
            const jobNumber = document.getElementById("job-number").value.trim();
            const dirtyIn = parseInt(modal.querySelector('[data-type="dirtyIn"] .bin-count-display').textContent, 10);
            const cleanOut = parseInt(modal.querySelector('[data-type="cleanOut"] .bin-count-display').textContent, 10);
            const editingId = modal.dataset.editingId ? parseInt(modal.dataset.editingId, 10) : null;
            
            if (editingId) {
                const txIndex = state.transactions.findIndex((t) => t.id === editingId);
                if (txIndex > -1) {
                    const oldTx = state.transactions[txIndex];
                    state.stock.dirty -= oldTx.dirtyIn;
                    state.stock.clean += oldTx.cleanOut;
                    state.stock.dirty += dirtyIn;
                    state.stock.clean -= cleanOut;
                    state.transactions[txIndex] = { ...oldTx, truckNumber, user: currentUser.name, jobNumber, dirtyIn, cleanOut };
                }
            } else {
                state.stock.dirty += dirtyIn;
                state.stock.clean -= cleanOut;
                state.transactions.push({ id: Date.now(), type: "truck", timestamp: new Date().toISOString(), truckNumber, dirtyIn, cleanOut, jobNumber, user: currentUser.name });
            }
            saveState();
            updateStockDisplay();
            renderTransactions();
            closeModal(modal);
        });

        document.getElementById("save-wash-btn").addEventListener("click", () => {
            const modal = document.getElementById("wash-modal");
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const quantity = parseInt(modal.querySelector(".bin-count-display").textContent, 10);
            const comment = document.getElementById("wash-comment").value.trim();
            if (quantity === 0) {
                alert("Quantity cannot be zero.");
                return;
            }
            const editingId = modal.dataset.editingId ? parseInt(modal.dataset.editingId, 10) : null;
            
            if (editingId) {
                const txIndex = state.transactions.findIndex((t) => t.id === editingId);
                if (txIndex > -1) {
                    const oldTx = state.transactions[txIndex];
                    if (quantity > state.stock.dirty + oldTx.quantity) {
                        alert("Not enough dirty bins."); return;
                    }
                    state.stock.dirty += oldTx.quantity;
                    state.stock.clean -= oldTx.quantity;
                    state.stock.dirty -= quantity;
                    state.stock.clean += quantity;
                    state.transactions[txIndex] = { ...oldTx, quantity, user: currentUser.name, comment };
                }
            } else {
                if (quantity > state.stock.dirty) {
                    alert("Cannot wash more bins than are in dirty stock."); return;
                }
                state.stock.dirty -= quantity;
                state.stock.clean += quantity;
                state.transactions.push({ id: Date.now(), type: "wash", timestamp: new Date().toISOString(), quantity, user: currentUser.name, comment });
            }
            saveState();
            updateStockDisplay();
            renderTransactions();
            closeModal(modal);
        });

        document.getElementById("save-adjust-btn").addEventListener("click", () => {
            const modal = document.getElementById("adjust-modal");
            if (!validateForm(modal)) return;
            const currentUser = getCurrentUser();
            if (!currentUser) return;
            
            const newClean = parseInt(document.getElementById("adjust-clean").value, 10);
            const newDirty = parseInt(document.getElementById("adjust-dirty").value, 10);
            const reason = document.getElementById("adjust-reason").value.trim();
            const oldClean = state.stock.clean;
            const oldDirty = state.stock.dirty;
            state.stock.clean = newClean;
            state.stock.dirty = newDirty;
            state.transactions.push({ id: Date.now(), type: "adjust", timestamp: new Date().toISOString(), newClean, newDirty, oldClean, oldDirty, reason, user: currentUser.name });
            
            saveState();
            updateStockDisplay();
            renderTransactions();
            closeModal(modal);
        });
        
        ui.transactionsContainer.addEventListener("click", (e) => {
          const target = e.target.closest(".delete-btn, .edit-btn");
          if (!target) return;
          const id = parseInt(target.dataset.id, 10);
          const txIndex = state.transactions.findIndex((t) => t.id === id);
          if (txIndex === -1) return;
          const tx = state.transactions[txIndex];
          if (target.classList.contains("delete-btn")) {
            if (!confirm("Are you sure you want to delete this entry?")) return;
            if (tx.type === "truck") {
              state.stock.dirty -= tx.dirtyIn;
              state.stock.clean += tx.cleanOut;
            } else if (tx.type === "wash") {
              state.stock.clean -= tx.quantity;
              state.stock.dirty += tx.quantity;
            }
            state.transactions.splice(txIndex, 1);
          } else if (target.classList.contains("edit-btn")) {
            if (tx.type === "adjust") {
              alert("Adjustment entries cannot be edited.");
              return;
            }
            const modal = document.getElementById(tx.type === "truck" ? "entry-modal" : "wash-modal");
            modal.dataset.editingId = tx.id;
            modal.querySelector("h2").textContent = `Edit ${tx.type} Entry`;
            if (tx.type === "truck") {
              document.getElementById("job-number").value = tx.jobNumber;
              document.getElementById("truck-number").value = tx.truckNumber;
              modal.querySelector('[data-type="dirtyIn"] .bin-count-display').textContent = tx.dirtyIn;
              modal.querySelector('[data-type="cleanOut"] .bin-count-display').textContent = tx.cleanOut;
            } else if (tx.type === "wash") {
              modal.querySelector(".bin-count-display").textContent = tx.quantity;
              document.getElementById("wash-comment").value = tx.comment;
            }
            openModal(modal);
          }
          saveState();
          updateStockDisplay();
          renderTransactions();
        });

        document.querySelector('.pin-pad').addEventListener('click', e => {
            const key = e.target.dataset.key;
            if (!key) return;

            ui.pinDisplay.classList.remove('error');
            let currentPin = ui.pinDisplay.textContent;

            if (key === 'clear') {
                ui.pinDisplay.textContent = '';
            } else if (key === 'login') {
                if (currentPin === '0000') {
                    openModal(ui.adminModal);
                    renderUserList();
                    ui.pinDisplay.textContent = '';
                    return;
                }

                const user = state.users.find(u => u.pin === currentPin);
                if (user) {
                    sessionStorage.setItem('currentUser', JSON.stringify(user));
                    location.reload();
                } else {
                    ui.pinDisplay.classList.add('error');
                    setTimeout(() => ui.pinDisplay.classList.remove('error'), 500);
                }
            } else {
                if (currentPin.length < 4) {
                    ui.pinDisplay.textContent += key;
                }
            }
        });
        
        function renderUserList() {
            ui.userList.innerHTML = '';
            state.users.forEach(user => {
                const li = document.createElement('li');
                li.className = 'user-list-item';
                li.innerHTML = `<span>${user.name} (PIN: ${user.pin})</span>`;
                if (user.pin !== '0000') {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-user-btn';
                    deleteBtn.textContent = 'üóëÔ∏è';
                    deleteBtn.dataset.id = user.id;
                    li.appendChild(deleteBtn);
                }
                ui.userList.appendChild(li);
            });
        }
        
        document.getElementById('admin-panel-btn').addEventListener('click', () => {
            alert('Enter the admin PIN (0000) on the keypad and press Login (‚úîÔ∏è) to access administration.');
        });

        document.getElementById('add-user-btn').addEventListener('click', () => {
            const nameInput = document.getElementById('new-user-name');
            const pinInput = document.getElementById('new-user-pin');
            const name = nameInput.value.trim();
            const pin = pinInput.value.trim();

            if (!name || !/^\d{4}$/.test(pin)) {
                alert('Please enter a valid name and a 4-digit PIN.');
                return;
            }
            if (state.users.some(u => u.pin === pin)) {
                alert('This PIN is already in use. Please choose another.');
                return;
            }

            state.users.push({ id: Date.now(), name, pin });
            saveState();
            renderUserList();
            nameInput.value = '';
            pinInput.value = '';
        });

        ui.userList.addEventListener('click', e => {
            if (e.target.classList.contains('delete-user-btn')) {
                if (!confirm('Are you sure you want to delete this user?')) return;
                const userId = parseInt(e.target.dataset.id, 10);
                state.users = state.users.filter(u => u.id !== userId);
                saveState();
                renderUserList();
            }
        });
        
        // --- REPORTING (FIXED) ---
        document.getElementById("report-btn").addEventListener("click", () => {
          const reportDateVal = ui.reportDateInput.value;
          if (!reportDateVal) {
            alert("Please select a date for the report.");
            return;
          }

          const reportDate = new Date(reportDateVal);
          const reportDateStr = new Date(
            reportDate.getTime() + reportDate.getTimezoneOffset() * 60000
          ).toLocaleDateString();

          const transactionsForDate = state.transactions.filter(
            (t) => new Date(t.timestamp).toLocaleDateString() === reportDateStr
          );

          if (transactionsForDate.length === 0) {
            alert(T("noDataForDate"));
            return;
          }

          const totalReceived = transactionsForDate
            .filter((t) => t.type === "truck")
            .reduce((sum, t) => sum + (t.dirtyIn || 0), 0);
          const totalShipped = transactionsForDate
            .filter((t) => t.type === "truck")
            .reduce((sum, t) => sum + (t.cleanOut || 0), 0);

          const washedByPerson = transactionsForDate
            .filter((t) => t.type === "wash")
            .reduce((acc, t) => {
              if (t.user) acc[t.user] = (acc[t.user] || 0) + t.quantity;
              return acc;
            }, {});

          const activityByUser = transactionsForDate.reduce((acc, t) => {
            if (t.user) acc[t.user] = (acc[t.user] || 0) + 1;
            return acc;
          }, {});

          const endOfDayClean = state.stock.clean;
          const endOfDayDirty = state.stock.dirty;

          const transactionRowsHtml = transactionsForDate
            .map((t, index) => {
              const d = new Date(t.timestamp);
              const date = d.toLocaleDateString("en-CA"); // YYYY-MM-DD
              const time = d.toLocaleTimeString([], { hour12: false, hour: "2-digit", minute: "2-digit" });
              const rowStyle = index % 2 === 0 ? "background-color: #ffffff;" : "background-color: #f3f5f7;";

              let typeCell = "", dirtyInCell = "0", cleanOutCell = "0", qtyCell = "", commentCell = "", jobNumberCell = "", truckCell = "";

              switch (t.type) {
                case "truck":
                  typeCell = '<span style="display: inline-block; padding: 4px 10px; font-size: 12px; font-weight: 700; border-radius: 12px; color: white; background-color: #3498db;">truck</span>';
                  dirtyInCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px; color: #e74c3c; font-weight: 600;">${t.dirtyIn || 0}</td>`;
                  cleanOutCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px; color: #27ae60; font-weight: 600;">${t.cleanOut || 0}</td>`;
                  qtyCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;"></td>`;
                  commentCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;"></td>`;
                  jobNumberCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;">${t.jobNumber || ""}</td>`;
                  truckCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;">${t.truckNumber || ""}</td>`;
                  break;
                case "wash":
                  typeCell = '<span style="display: inline-block; padding: 4px 10px; font-size: 12px; font-weight: 700; border-radius: 12px; color: white; background-color: #2ecc71;">wash</span>';
                  dirtyInCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;"></td>`;
                  cleanOutCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;"></td>`;
                  qtyCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;">${t.quantity}</td>`;
                  commentCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;">${t.comment || ""}</td>`;
                  jobNumberCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;"></td>`;
                  truckCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;"></td>`;
                  break;
                case "adjust":
                  typeCell = '<span style="display: inline-block; padding: 4px 10px; font-size: 12px; font-weight: 700; border-radius: 12px; color: white; background-color: #f39c12;">adjust</span>';
                  dirtyInCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;"></td>`;
                  cleanOutCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;"></td>`;
                  qtyCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;"></td>`;
                  commentCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;">${t.reason || ""}</td>`;
                  jobNumberCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;"></td>`;
                  truckCell = `<td style="border: 1px solid #dfe2e5; padding: 10px 15px;"></td>`;
                  break;
              }

              return `<tr style="${rowStyle}">
                        <td style="border: 1px solid #dfe2e5; padding: 10px 15px;">${date}</td>
                        <td style="border: 1px solid #dfe2e5; padding: 10px 15px;">${time}</td>
                        <td style="border: 1px solid #dfe2e5; padding: 10px 15px;">${typeCell}</td>
                        <td style="border: 1px solid #dfe2e5; padding: 10px 15px;">${t.user || ""}</td>
                        ${jobNumberCell}
                        ${truckCell}
                        ${dirtyInCell}
                        ${cleanOutCell}
                        ${qtyCell}
                        ${commentCell}
                    </tr>`;
            }).join("");

          const sortedActivity = Object.entries(activityByUser).sort((a, b) => a[0].localeCompare(b[0]));
          const washingEntries = Object.entries(washedByPerson);
          const maxRows = Math.max(washingEntries.length, sortedActivity.length, 2);
          let summaryTableBodyHtml = "";

          for (let i = 0; i < maxRows; i++) {
            let endOfDayHtml = i === 0 ? `<td style="padding: 8px; border-left: 1px solid #dfe2e5; text-align: right; font-weight: bold; color: #27ae60;">${T('cleanStock')}:</td><td style="padding: 8px; border-right: 5px solid #34495e; text-align: left; font-weight: bold; font-size: 16px; color: #27ae60;">${endOfDayClean}</td>`
                : i === 1 ? `<td style="padding: 8px; border-left: 1px solid #dfe2e5; text-align: right; font-weight: bold; color: #e74c3c;">${T('dirtyStock')}:</td><td style="padding: 8px; border-right: 5px solid #34495e; text-align: left; font-weight: bold; font-size: 16px; color: #e74c3c;">${endOfDayDirty}</td>`
                : `<td style="padding: 8px; border-left: 1px solid #dfe2e5;"></td><td style="padding: 8px; border-right: 5px solid #34495e;"></td>`;

            let movementHtml = i === 0 ? `<td style="padding: 8px; text-align: right;">${T('totalReceived')}:</td><td style="padding: 8px; border-right: 5px solid #34495e; text-align: left;"><b>${totalReceived}</b></td>`
                : i === 1 ? `<td style="padding: 8px; text-align: right;">${T('totalShipped')}:</td><td style="padding: 8px; border-right: 5px solid #34495e; text-align: left;"><b>${totalShipped}</b></td>`
                : `<td style="padding: 8px;"></td><td style="padding: 8px; border-right: 5px solid #34495e;"></td>`;

            let washingHtml = washingEntries[i] ? `<td style="padding: 8px; text-align: right;">${washingEntries[i][0]}:</td><td style="padding: 8px; border-right: 5px solid #34495e; text-align: left;"><b>${washingEntries[i][1]}</b></td>`
              : `<td style="padding: 8px;"></td><td style="padding: 8px; border-right: 5px solid #34495e;"></td>`;
            let activityHtml = sortedActivity[i] ? `<td style="padding: 8px; text-align: right;">${sortedActivity[i][0]}:</td><td style="padding: 8px; border-right: 1px solid #dfe2e5; text-align: left;"><b>${sortedActivity[i][1]} op(s)</b></td>`
              : `<td style="padding: 8px;"></td><td style="padding: 8px; border-right: 1px solid #dfe2e5;"></td>`;

            summaryTableBodyHtml += `<tr>${endOfDayHtml}${movementHtml}${washingHtml}${activityHtml}</tr>`;
          }
          summaryTableBodyHtml += `<tr style="border-bottom: 1px solid #dfe2e5;"><td style="padding: 8px; border-left: 1px solid #dfe2e5;"></td><td style="padding: 8px; border-right: 5px solid #34495e;"></td><td style="padding: 8px;"></td><td style="padding: 8px; border-right: 5px solid #34495e;"></td><td style="padding: 8px;"></td><td style="padding: 8px; border-right: 5px solid #34495e;"></td><td style="padding: 8px;"></td><td style="padding: 8px; border-right: 1px solid #dfe2e5;"></td></tr>`;

          const fullHtmlReport = `
                <body style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif; margin: 20px; background-color: #f9f9f9;">
                    <h2 style="font-family: inherit; color: #2c3e50;">Operations Log</h2>
                    <table style="border-collapse: collapse; width: 100%;">
                        <thead>
                            <tr style="background-color: #2c3e50; color: #ffffff;">
                                <th style="width: 100px; padding: 12px 15px; border: 1px solid #2c3e50; font-weight: 600; text-transform: uppercase; font-size: 12px; text-align: left;">Date</th>
                                <th style="width: 90px; padding: 12px 15px; border: 1px solid #2c3e50; font-weight: 600; text-transform: uppercase; font-size: 12px; text-align: left;">Time</th>
                                <th style="width: 80px; padding: 12px 15px; border: 1px solid #2c3e50; font-weight: 600; text-transform: uppercase; font-size: 12px; text-align: left;">Type</th>
                                <th style="width: 120px; padding: 12px 15px; border: 1px solid #2c3e50; font-weight: 600; text-transform: uppercase; font-size: 12px; text-align: left;">${T('employeeName')}</th>
                                <th style="width: 120px; padding: 12px 15px; border: 1px solid #2c3e50; font-weight: 600; text-transform: uppercase; font-size: 12px; text-align: left;">${T('jobNumber')}</th>
                                <th style="width: 100px; padding: 12px 15px; border: 1px solid #2c3e50; font-weight: 600; text-transform: uppercase; font-size: 12px; text-align: left;">${T('truck')}</th>
                                <th style="width: 80px; padding: 12px 15px; border: 1px solid #2c3e50; font-weight: 600; text-transform: uppercase; font-size: 12px; text-align: left;">${T('inboundDirty')}</th>
                                <th style="width: 90px; padding: 12px 15px; border: 1px solid #2c3e50; font-weight: 600; text-transform: uppercase; font-size: 12px; text-align: left;">${T('outboundClean')}</th>
                                <th style="width: 80px; padding: 12px 15px; border: 1px solid #2c3e50; font-weight: 600; text-transform: uppercase; font-size: 12px; text-align: left;">${T('quantityWashed')}</th>
                                <th style="width: 200px; padding: 12px 15px; border: 1px solid #2c3e50; font-weight: 600; text-transform: uppercase; font-size: 12px; text-align: left;">${T('comment')}</th>
                            </tr>
                        </thead>
                        <tbody>${transactionRowsHtml}</tbody>
                    </table>
                    <br>
                    <h2 style="font-family: inherit; color: #2c3e50;">${T('summaryTitle')}</h2>
                    <table style="border-collapse: collapse; border-spacing: 0;">
                        <thead>
                            <tr style="background-color: #34495e; color: #ffffff;">
                                <th colspan="2" style="padding: 12px; border: 1px solid #34495e; border-right-width: 5px; text-align: center; font-size: 13px;">End-of-Day Totals</th>
                                <th colspan="2" style="padding: 12px; border: 1px solid #34495e; border-right-width: 5px; text-align: center; font-size: 13px;">${T('binMovement')}</th>
                                <th colspan="2" style="padding: 12px; border: 1px solid #34495e; border-right-width: 5px; text-align: center; font-size: 13px;">${T('washingSummary')}</th>
                                <th colspan="2" style="padding: 12px; border: 1px solid #34495e; text-align: center; font-size: 13px;">${T('activityByUser')}</th>
                            </tr>
                        </thead>
                        <tbody style="font-size: 14px; background-color: #f3f5f7;">${summaryTableBodyHtml}</tbody>
                    </table>
                </body>`;
          
          document.getElementById("report-html-container").innerHTML = fullHtmlReport;
          document.getElementById("copy-report-btn").querySelector("span").textContent = T("copyData");
          openModal(document.getElementById("report-modal"));
        });

        document.getElementById('copy-report-btn').addEventListener('click', () => {
             const reportContainer = document.getElementById("report-html-container");
            const selection = window.getSelection();
            const range = document.createRange();
            range.selectNodeContents(reportContainer);
            selection.removeAllRanges();
            selection.addRange(range);
            try {
              const successful = document.execCommand("copy");
              if (successful) {
                const copyButtonSpan = document.getElementById("copy-report-btn").querySelector("span");
                const originalText = T("copyData");
                copyButtonSpan.textContent = T("copied");
                setTimeout(() => { copyButtonSpan.textContent = originalText; }, 2000);
              } else {
                alert("Copy failed.");
              }
            } catch (err) {
              console.error("Failed to copy report: ", err);
              alert("Could not copy report.");
            }
            selection.removeAllRanges();
        });
        document.getElementById('backup-btn').addEventListener('click', () => {
            const dataStr = JSON.stringify(state, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            a.download = `bintracker_backup_${new Date().toISOString().split("T")[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
        const restoreInput = document.getElementById("restore-file-input");
        document.getElementById('restore-btn').addEventListener('click', () => restoreInput.click());
        restoreInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            if (!confirm("This will OVERWRITE all current data. Are you sure?")) {
                e.target.value = ""; return;
            }
            const reader = new FileReader();
            reader.onload = (event) => {
                try {
                    const restoredState = JSON.parse(event.target.result);
                    if (restoredState.stock && restoredState.transactions) {
                        state = restoredState;
                        saveState();
                        alert("Data restored successfully! The page will now reload.");
                        location.reload();
                    } else {
                        alert("Invalid backup file format.");
                    }
                } catch (err) {
                    alert("Error reading backup file.");
                }
            };
            reader.readAsText(file);
            e.target.value = "";
        });

        // --- INITIALIZATION ---
        const initializeApp = () => {
            loadState();
            setLanguage(state.language || 'en'); // Set language early

            const currentUser = sessionStorage.getItem('currentUser');
            if (currentUser) {
                const user = JSON.parse(currentUser);
                ui.appContainer.classList.remove('hidden');
                ui.loginModal.style.display = 'none';
                
                ui.userInfo.classList.remove('hidden');
                ui.currentUserName.textContent = user.name;
                document.getElementById('current-user-greeting').textContent = T('currentUserGreeting');
                
                ui.reportDateInput.valueAsDate = new Date();
                updateStockDisplay();
                renderTransactions();
                setupInactivityListeners();
            } else {
                ui.appContainer.classList.add('hidden');
                openModal(ui.loginModal);
            }
            
            Object.values(document.querySelectorAll(".lang-switcher button")).forEach((btn) => btn.addEventListener("click", () => setLanguage(btn.id.split("-")[1])));
            
            document.getElementById('logout-btn').addEventListener('click', handleLogout);

            document.getElementById("save-setup-btn").addEventListener("click", () => {
              const initialClean = parseInt(document.getElementById("initial-clean").value, 10);
              const initialDirty = parseInt(document.getElementById("initial-dirty").value, 10);
              if (isNaN(initialClean) || isNaN(initialDirty)) {
                alert("Please enter valid numbers."); return;
              }
              state.stock.clean = initialClean;
              state.stock.dirty = initialDirty;
              saveState();
              updateStockDisplay();
              closeModal(document.getElementById("setup-modal"));
            });
        };

        initializeApp();
      });
    </script>
  </body>
</html>
